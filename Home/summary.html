<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surveyor - Summary</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --kt-primary: #163300;
            --kt-primary-light: #EEE6DA;
            --kt-accent: #9FE870;
            --kt-success: #50CD89;
            --kt-success-light: #E8FFF3;
            --kt-warning: #FFC700;
            --kt-warning-light: #FFF8DD;
            --kt-danger: #F1416C;
            --kt-danger-light: #FFF5F8;
            --kt-info: #7239EA;
            --kt-gray-100: #F9F9F9;
            --kt-gray-200: #F1F1F2;
            --kt-gray-300: #E1E3EA;
            --kt-gray-400: #B5B5C3;
            --kt-gray-500: #A1A5B7;
            --kt-gray-600: #7E8299;
            --kt-gray-700: #5E6278;
            --kt-gray-800: #3F4254;
            --kt-gray-900: #181C32;
            --sidebar-width: 220px;
            --rating-a: #50CD89;
            --rating-b: #FFC700;
            --rating-c: #F6B100;
            --rating-d: #F1416C;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fff;
            min-height: 100vh;
        }

        /* ========== LEFT SIDEBAR ========== */
        .sidebar {
            width: var(--sidebar-width);
            background: #fff;
            border-right: 1px solid var(--kt-gray-200);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width 0.25s ease;
        }

        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: 11px; }
        .sidebar.collapsed .nav-text, .sidebar.collapsed .chevron { display: none; }
        .sidebar.collapsed .nav-item { position: relative; }
        .sidebar.collapsed .nav-item::after {
            content: attr(data-title);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--kt-gray-900);
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            margin-left: 10px;
            z-index: 1000;
        }
        .sidebar.collapsed .nav-item:hover::after { opacity: 1; visibility: visible; }
        .sidebar.collapsed .nav-item svg { margin: 0; }
        .sidebar.collapsed .switch-classic { justify-content: center; padding: 10px; }
        .sidebar.collapsed .switch-classic span { display: none; }
        .switch-classic span { white-space: nowrap; overflow: hidden; }

        body.sidebar-collapsed .top-header { left: 70px; }
        body.sidebar-collapsed .secondary-nav { left: 70px; }
        body.sidebar-collapsed .toolbar-ribbon { left: 70px; }
        body.sidebar-collapsed .main-content { margin-left: 70px; }

        .sidebar-logo {
            padding: 15px 16px;
            border-bottom: 1px solid var(--kt-gray-200);
            display: flex;
            align-items: center;
            gap: 10px;
            height: 60px;
        }
        .sidebar-logo img { width: 32px; height: 32px; border-radius: 6px; }
        .sidebar.collapsed .sidebar-logo { justify-content: center; padding: 15px 10px; }
        .sidebar.collapsed .sidebar-logo img { width: 40px; height: 40px; }
        .sidebar.collapsed .sidebar-logo span { display: none; }
        .sidebar-logo span { font-size: 1.1rem; font-weight: 600; color: var(--kt-accent); }

        .nav-menu { padding: 12px 10px; flex: 1; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 14px;
            border-radius: 6px;
            color: var(--kt-gray-700);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 2px;
            user-select: none;
        }
        .nav-item:hover { background: var(--kt-gray-100); color: var(--kt-gray-900); }
        .nav-item:active { transform: scale(0.98); }
        .nav-item.active { background: var(--kt-primary-light); color: var(--kt-primary); }
        .nav-item.active:hover { background: var(--kt-primary-light); }
        .nav-item svg { width: 18px; height: 18px; stroke: currentColor; flex-shrink: 0; }
        .nav-text { flex: 1; white-space: nowrap; overflow: hidden; }
        .nav-item .chevron { margin-left: auto; width: 16px; height: 16px; stroke: var(--kt-gray-400); }

        .sidebar-footer { padding: 16px; border-top: 1px solid var(--kt-gray-200); }
        .switch-classic {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--kt-gray-100);
            border-radius: 6px;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            cursor: pointer;
        }
        .switch-classic svg { width: 18px; height: 18px; stroke: #17a388; }

        /* ========== TOP HEADER ========== */
        .top-header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: 60px;
            background: #fff;
            border-bottom: 1px solid var(--kt-gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 99;
            transition: left 0.25s ease;
        }
        .header-left { display: flex; align-items: center; gap: 8px; }
        .collapse-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--kt-gray-500);
        }
        .header-nav-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--kt-gray-700);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s;
        }
        .header-nav-item:hover { color: var(--kt-primary); }
        .header-nav-item svg { width: 16px; height: 16px; stroke: currentColor; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--kt-gray-100);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--kt-gray-600);
        }
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--kt-gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--kt-gray-700);
            font-size: 0.875rem;
        }

        /* ========== SECONDARY NAV RIBBON ========== */
        .secondary-nav {
            position: fixed;
            top: 60px;
            left: var(--sidebar-width);
            right: 0;
            height: 50px;
            background: #fff;
            border-bottom: 1px solid var(--kt-gray-200);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 20px;
            gap: 16px;
            z-index: 98;
            transition: left 0.25s ease;
        }
        .secondary-nav-left { display: flex; align-items: center; gap: 8px; }
        .secondary-nav-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 5px;
            color: var(--kt-gray-600);
            text-decoration: none;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: all 0.15s;
        }
        .secondary-nav-item:hover { background: var(--kt-gray-100); color: var(--kt-gray-800); }
        .secondary-nav-item.active { background: var(--kt-primary-light); color: var(--kt-primary); }
        .secondary-nav-item svg { width: 16px; height: 16px; stroke: currentColor; }

        /* ========== TOOLBAR RIBBON ========== */
        .toolbar-ribbon {
            position: fixed;
            top: 110px;
            left: var(--sidebar-width);
            right: 0;
            min-height: 56px;
            background: #fff;
            border-bottom: 1px solid var(--kt-gray-200);
            display: flex;
            align-items: center;
            padding: 8px 20px;
            gap: 12px;
            z-index: 97;
            transition: left 0.25s ease;
            flex-wrap: wrap;
        }

        /* Metronic-style Combined Search Box */
        .search-box-combined {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid var(--kt-gray-300);
            border-radius: 6px;
            overflow: hidden;
            transition: all 0.15s ease;
            padding: 0 2px;
            height: 44px;
        }
        .search-box-combined:focus-within {
            border-color: var(--kt-primary);
            box-shadow: 0 0 0 3px var(--kt-primary-light);
        }
        .search-input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-input-wrapper svg {
            position: absolute;
            left: 12px;
            width: 14px;
            height: 14px;
            stroke: var(--kt-gray-400);
            pointer-events: none;
        }
        .search-input-wrapper input {
            width: 100%;
            min-width: 280px;
            padding: 6px 12px 6px 34px;
            border: none;
            font-size: 0.8125rem;
            font-family: inherit;
            color: var(--kt-gray-800);
            background: transparent;
            outline: none;
        }
        .search-input-wrapper input::placeholder {
            color: var(--kt-gray-400);
        }
        .btn-group-infix {
            display: flex;
            background: var(--kt-gray-100);
            padding: 2px;
            margin: 0;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .search-divider {
            width: 1px;
            height: 20px;
            background: var(--kt-gray-200);
            margin: 0 10px;
            flex-shrink: 0;
        }
        .btn-filter {
            padding: 4px 10px;
            font-size: 0.7rem;
            font-weight: 500;
            border: none;
            background: transparent;
            color: var(--kt-gray-600);
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 3px;
            white-space: nowrap;
        }
        .btn-filter:hover { background: var(--kt-gray-200); }
        .btn-filter.active {
            background: var(--kt-primary);
            color: #fff;
        }
        .btn-search {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 16px;
            height: 36px;
            margin-right: 2px;
            background: var(--kt-primary);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease;
        }
        .btn-search:hover { background: #0f2200; }
        .btn-search svg { width: 14px; height: 14px; stroke: currentColor; }

        /* Filter Group Container - Match search box padding */
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 4px;
            background: #fff;
            border: 1px solid var(--kt-gray-300);
            border-radius: 6px;
            flex-wrap: wrap;
            height: 44px;
        }
        .filter-group-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--kt-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .filter-divider {
            width: 1px;
            height: 24px;
            background: var(--kt-gray-300);
            margin: 0 4px;
        }

        /* Date Range Section */
        .date-range-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .date-range-section select {
            height: 32px;
            padding: 0 28px 0 10px;
            border: 1px solid var(--kt-gray-300);
            border-radius: 4px;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%237E8299' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") right 8px center no-repeat;
            font-size: 0.75rem;
            color: var(--kt-gray-700);
            cursor: pointer;
            appearance: none;
        }
        .custom-date-range {
            display: none;
            align-items: center;
            gap: 6px;
        }
        .custom-date-range.show { display: flex; }
        .custom-date-range input[type="date"] {
            height: 32px;
            padding: 0 8px;
            border: 1px solid var(--kt-gray-300);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--kt-gray-700);
            background: #fff;
        }
        .custom-date-range span {
            font-size: 0.75rem;
            color: var(--kt-gray-500);
        }

        /* Multi-select dropdown */
        .multiselect-wrapper {
            position: relative;
            height: 32px;
        }
        .multiselect-btn {
            height: 100%;
            padding: 0 28px 0 10px;
            border: 1px solid var(--kt-gray-300);
            border-radius: 4px;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%237E8299' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") right 8px center no-repeat;
            font-size: 0.75rem;
            color: var(--kt-gray-700);
            cursor: pointer;
            min-width: 100px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s;
        }
        .multiselect-btn:hover { border-color: var(--kt-gray-400); }
        .multiselect-btn.active {
            border-color: var(--kt-primary);
            box-shadow: 0 0 0 2px var(--kt-primary-light);
        }
        .multiselect-badge {
            background: var(--kt-primary);
            color: #fff;
            font-size: 0.625rem;
            padding: 1px 5px;
            border-radius: 3px;
            font-weight: 600;
        }
        .multiselect-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            min-width: 280px;
            background: #fff;
            border: 1px solid var(--kt-gray-300);
            border-radius: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        .multiselect-dropdown.show { display: block; }

        /* Tree View for Inspection Columns */
        .tree-group {
            border-bottom: 1px solid var(--kt-gray-200);
        }
        .tree-group:last-child { border-bottom: none; }
        .tree-group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--kt-gray-100);
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--kt-gray-800);
            user-select: none;
        }
        .tree-group-header:hover { background: var(--kt-gray-200); }
        .tree-group-header svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            transition: transform 0.2s;
        }
        .tree-group-header.collapsed svg { transform: rotate(-90deg); }
        .tree-group-header input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: var(--kt-primary);
        }
        .tree-group-items {
            padding-left: 24px;
        }
        .tree-group-items.collapsed { display: none; }
        .tree-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            transition: background 0.15s;
        }
        .tree-item:hover { background: var(--kt-gray-100); }
        .tree-item input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: var(--kt-primary);
            cursor: pointer;
        }

        .multiselect-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            transition: background 0.15s;
        }
        .multiselect-option:hover { background: var(--kt-gray-100); }
        .multiselect-option input[type="checkbox"] {
            width: 14px;
            height: 14px;
            accent-color: var(--kt-primary);
            cursor: pointer;
        }

        /* Rating Option in dropdown */
        .rating-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .rating-option .condition-badge {
            flex-shrink: 0;
        }

        /* Mini Rating Badges for button */
        .rating-badge-mini {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 3px;
            font-size: 0.625rem;
            font-weight: 700;
            color: #fff;
        }
        .rating-badge-mini.rating-a { background: var(--rating-a); }
        .rating-badge-mini.rating-b { background: var(--rating-b); }
        .rating-badge-mini.rating-c { background: var(--rating-c); }
        .rating-badge-mini.rating-d { background: var(--rating-d); }

        #conditionRatingBtn {
            gap: 3px;
            padding-left: 6px;
        }
        #conditionRatingBtn .multiselect-badge {
            margin-left: 4px;
        }

        /* Apply Button - Inside filter group */
        .btn-apply {
            height: 36px;
            padding: 0 16px;
            background: var(--kt-primary);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.15s;
            white-space: nowrap;
            margin-left: 4px;
        }
        .btn-apply:hover { background: #0f2200; }
        .btn-apply:disabled {
            background: var(--kt-gray-300);
            cursor: not-allowed;
        }
        .btn-apply svg { width: 14px; height: 14px; stroke: currentColor; }

        .toolbar-spacer { flex: 1; }

        /* Expand All / Collapse All Button - Icon only with tooltip */
        .btn-expand-all {
            width: 36px;
            height: 36px;
            padding: 0;
            background: #fff;
            color: var(--kt-gray-700);
            border: 1px solid var(--kt-gray-300);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            position: relative;
        }
        .btn-expand-all span { display: none; }
        .btn-expand-all:hover {
            background: var(--kt-gray-100);
            border-color: var(--kt-gray-400);
        }
        .btn-expand-all svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            transition: transform 0.2s;
        }
        .btn-expand-all.collapsed svg {
            transform: rotate(-90deg);
        }
        /* Tooltip for expand button - Bottom position */
        .btn-expand-all::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--kt-gray-900);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.6875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
            margin-top: 6px;
            z-index: 100;
        }
        .btn-expand-all:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Export Button - Icon only with tooltip */
        .btn-export {
            width: 36px;
            height: 36px;
            padding: 0;
            background: var(--kt-accent);
            color: var(--kt-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            position: relative;
        }
        .btn-export:hover { background: #8CD960; }
        .btn-export svg { width: 16px; height: 16px; stroke: currentColor; }
        .btn-export span { display: none; }
        /* Tooltip for export button - Bottom position */
        .btn-export::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--kt-gray-900);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.6875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
            margin-top: 6px;
            z-index: 100;
        }
        .btn-export:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: 166px;
            min-height: calc(100vh - 166px);
            transition: margin-left 0.25s ease;
            background: var(--kt-gray-100);
            padding: 20px;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .card-body {
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .table-wrapper {
            overflow-x: hidden;
            overflow-y: visible;
            flex: 1;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
            table-layout: fixed;
        }
        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .data-table th {
            background: var(--kt-gray-100);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--kt-gray-600);
            border-bottom: 1px solid var(--kt-gray-200);
            white-space: nowrap;
        }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--kt-gray-200);
            color: var(--kt-gray-700);
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Property table column widths */
        .data-table th:first-child,
        .data-table td:first-child { width: 30%; }
        .data-table th:last-child,
        .data-table td:last-child {
            width: 100px;
            text-align: right;
        }
        .data-table tbody tr:hover:not(.inspection-container) { background: var(--kt-gray-100); }
        .data-table tbody tr:last-child td { border-bottom: none; }

        /* Property action buttons right aligned */
        .data-table .action-buttons {
            justify-content: flex-end;
        }

        /* Property row with expanded inspections */
        .data-table tbody tr.property-expanded {
            background: var(--kt-primary-light);
        }
        .data-table tbody tr.property-expanded td {
            border-bottom-color: var(--kt-gray-300);
        }
        .data-table tbody tr.property-expanded:hover {
            background: var(--kt-primary-light);
        }

        /* Cell Styles - No hyperlinks */
        .cell-text {
            color: var(--kt-gray-800);
            font-weight: 500;
        }

        .cell-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .cell-status.pending { background: var(--kt-warning-light); color: #B59600; }
        .cell-status.uploaded { background: var(--kt-success-light); color: #1B8A5A; }
        .cell-status.uploading { background: rgba(114, 57, 234, 0.1); color: var(--kt-info); }
        .cell-status.transcribing { background: var(--kt-primary-light); color: var(--kt-primary); }

        /* Minimal Check Icon - Just green check, no background */
        .cell-check {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }
        .cell-check svg {
            width: 16px;
            height: 16px;
            stroke: var(--kt-success);
            stroke-width: 2.5;
        }
        .cell-check.empty svg {
            stroke: var(--kt-gray-300);
        }

        .cell-flag {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cell-flag.danger { background: var(--kt-danger); }
        .cell-flag svg { width: 12px; height: 12px; stroke: #fff; }

        /* Condition Rating Badge (renamed from Risk Rating) */
        .condition-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #fff;
        }
        .condition-badge.rating-a { background: var(--rating-a); }
        .condition-badge.rating-b { background: var(--rating-b); }
        .condition-badge.rating-c { background: var(--rating-c); }
        .condition-badge.rating-d { background: var(--rating-d); }

        /* View Button */
        .btn-view {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid var(--kt-gray-300);
            background: #fff;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--kt-gray-700);
        }
        .btn-view:hover {
            background: var(--kt-gray-100);
            border-color: var(--kt-gray-400);
        }
        .btn-view svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }

        /* Property Action Buttons */
        .prop-actions {
            display: flex;
            gap: 6px;
        }
        .prop-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid var(--kt-gray-300);
            background: #fff;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--kt-gray-700);
        }
        .prop-action-btn:hover {
            background: var(--kt-gray-100);
            border-color: var(--kt-gray-400);
        }
        .prop-action-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }
        .prop-action-btn.expand-action {
            background: var(--kt-primary-light);
            border-color: var(--kt-primary-light);
            color: var(--kt-primary);
        }
        .prop-action-btn.expand-action:hover {
            background: var(--kt-primary);
            border-color: var(--kt-primary);
            color: #fff;
        }
        .prop-action-btn.expand-action.expanded {
            background: var(--kt-primary);
            border-color: var(--kt-primary);
            color: #fff;
        }
        .prop-action-btn.export-action {
            background: rgba(159, 232, 112, 0.2);
            border-color: rgba(159, 232, 112, 0.3);
            color: var(--kt-primary);
        }
        .prop-action-btn.export-action:hover {
            background: var(--kt-accent);
            border-color: var(--kt-accent);
            color: var(--kt-primary);
        }

        /* Inspection Sub-table - No margin, match property UI */
        .inspection-container td {
            padding: 0 !important;
            background: var(--kt-gray-100);
        }
        .sub-table-wrapper {
            margin: 0;
            background: #fff;
            border-top: 1px solid var(--kt-gray-200);
        }
        .sub-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }
        .sub-table th {
            background: var(--kt-gray-100);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--kt-gray-600);
            border-bottom: 1px solid var(--kt-gray-200);
            white-space: nowrap;
            font-size: 0.75rem;
        }
        .sub-table th:first-child {
            padding-left: 24px;
        }
        .sub-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--kt-gray-200);
            color: var(--kt-gray-700);
            vertical-align: middle;
            white-space: nowrap;
        }
        .sub-table td:first-child {
            padding-left: 24px;
        }
        .sub-table tbody tr:hover { background: var(--kt-gray-50); }
        .sub-table tbody tr:last-child td { border-bottom: none; }

        /* Totals row */
        .totals-row {
            background: var(--kt-gray-100);
        }
        .totals-row td {
            padding: 12px 16px;
            border-top: 2px solid var(--kt-gray-300);
            border-bottom: none !important;
        }
        .totals-row td:first-child {
            padding-left: 24px;
        }

        /* Filter indicator */
        .filter-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px 8px 24px;
            background: var(--kt-primary-light);
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--kt-primary);
            border-bottom: 1px solid var(--kt-gray-200);
        }
        .filter-indicator .rating-badge-mini {
            margin-left: 2px;
        }

        /* Filtered cost display */
        .filtered-cost {
            color: var(--kt-primary);
            font-weight: 600;
        }
        .total-cost-ref {
            color: var(--kt-gray-400);
            font-size: 0.75rem;
            margin-left: 4px;
        }

        /* Item count badge */
        .item-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            margin-left: 8px;
            background: var(--kt-primary-light);
            color: var(--kt-primary);
            font-size: 0.625rem;
            font-weight: 600;
            border-radius: 10px;
        }

        /* Flagged count badge */
        .flagged-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--kt-danger);
            color: #fff;
            font-size: 0.6875rem;
            font-weight: 600;
            border-radius: 10px;
        }

        /* Small cell text for sections */
        .cell-text-small {
            font-size: 0.75rem;
            color: var(--kt-gray-600);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }

        /* Items list display */
        .items-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .item-row {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            height: 22px;
            color: var(--kt-gray-700);
        }
        .item-row .condition-badge {
            width: 20px;
            height: 20px;
            font-size: 0.65rem;
        }
        .item-row .cell-flag {
            width: 18px;
            height: 18px;
        }
        .item-row .cell-flag svg {
            width: 10px;
            height: 10px;
        }

        /* Skeleton loading */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, var(--kt-gray-200) 25%, var(--kt-gray-100) 50%, var(--kt-gray-200) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        .skeleton-sub-table {
            width: 100%;
            background: #fff;
            overflow: hidden;
        }
        .skeleton-row {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--kt-gray-200);
        }
        .skeleton-cell {
            height: 16px;
            border-radius: 4px;
        }
        .skeleton-cell.w-120 { width: 120px; }
        .skeleton-cell.w-80 { width: 80px; }
        .skeleton-cell.w-60 { width: 60px; }
        .skeleton-cell.w-40 { width: 40px; }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--kt-gray-300);
            border-top-color: var(--kt-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Table Footer - Pagination - Always visible at bottom */
        .table-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-top: 1px solid var(--kt-gray-200);
            background: #fff;
            flex-wrap: wrap;
            gap: 12px;
            border-radius: 0 0 8px 8px;
            flex-shrink: 0;
        }
        .table-info {
            font-size: 0.8125rem;
            color: var(--kt-gray-600);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .table-info strong { color: var(--kt-gray-800); }

        /* Rows per page selector */
        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8125rem;
            color: var(--kt-gray-600);
        }
        .rows-per-page select {
            height: 32px;
            padding: 0 28px 0 10px;
            border: 1px solid var(--kt-gray-300);
            border-radius: 4px;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%237E8299' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") right 8px center no-repeat;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            cursor: pointer;
            appearance: none;
        }

        /* Pagination controls */
        .pagination {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .pagination-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            padding: 0 8px;
            border: 1px solid var(--kt-gray-300);
            border-radius: 4px;
            background: #fff;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--kt-gray-700);
            cursor: pointer;
            transition: all 0.15s;
        }
        .pagination-btn:hover:not(:disabled):not(.active) {
            background: var(--kt-gray-100);
            border-color: var(--kt-gray-400);
        }
        .pagination-btn.active {
            background: var(--kt-primary);
            border-color: var(--kt-primary);
            color: #fff;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }
        .pagination-ellipsis {
            padding: 0 4px;
            color: var(--kt-gray-500);
            font-size: 0.8125rem;
        }

        /* Property count badge */
        .property-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--kt-gray-200);
            border-radius: 10px;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--kt-gray-600);
            margin-left: 8px;
        }

        /* Cost value */
        .cost-value {
            font-weight: 600;
            color: var(--kt-gray-800);
        }

        /* Chat FAB */
        .chat-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: #7ed321;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(126, 211, 33, 0.4);
            cursor: pointer;
            z-index: 100;
        }
        .chat-fab svg { width: 24px; height: 24px; stroke: #fff; }

        /* ========== RESPONSIVE STYLES ========== */
        @media (max-width: 1400px) {
            .toolbar-ribbon {
                flex-wrap: wrap;
                height: auto;
                padding: 12px 20px;
                gap: 10px;
            }
            .search-date-group {
                flex: 1;
                min-width: 300px;
            }
        }

        @media (max-width: 1200px) {
            .sidebar { width: 70px; }
            .sidebar .nav-text, .sidebar .chevron { display: none; }
            .sidebar .nav-item { justify-content: center; padding: 11px; }
            .sidebar .sidebar-logo { justify-content: center; padding: 15px 10px; }
            .sidebar .sidebar-logo img { width: 40px; height: 40px; }
            .sidebar .sidebar-logo span { display: none; }
            .sidebar .switch-classic { justify-content: center; padding: 10px; }
            .sidebar .switch-classic span { display: none; }

            .top-header, .secondary-nav, .toolbar-ribbon { left: 70px; }
            .main-content { margin-left: 70px; }
        }

        @media (max-width: 992px) {
            .filter-group { flex-wrap: wrap; }
            .search-date-group { min-width: 100%; order: -1; }
            .data-table { min-width: 800px; }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: var(--sidebar-width);
            }
            .sidebar.mobile-open { transform: translateX(0); }
            .sidebar .nav-text, .sidebar .chevron { display: block; }
            .sidebar .nav-item { justify-content: flex-start; padding: 11px 14px; }
            .sidebar .sidebar-logo { justify-content: flex-start; padding: 15px 16px; }
            .sidebar .sidebar-logo span { display: block; }

            .top-header, .secondary-nav, .toolbar-ribbon { left: 0; }
            .main-content { margin-left: 0; padding: 15px; }

            .secondary-nav {
                overflow-x: auto;
                gap: 8px;
            }
            .secondary-nav-item {
                padding: 6px 10px;
                font-size: 0.75rem;
                white-space: nowrap;
            }

            .toolbar-ribbon {
                padding: 10px 15px;
            }
            .filter-group {
                width: 100%;
                padding: 8px;
            }
            .multiselect-wrapper {
                flex: 1;
                min-width: calc(50% - 4px);
            }
            .multiselect-btn {
                width: 100%;
                min-width: auto;
            }

            .btn-apply { width: 100%; justify-content: center; }
            .btn-export { width: 100%; justify-content: center; }

            .header-nav-item span { display: none; }

            .prop-actions { flex-wrap: wrap; }
        }

        @media (max-width: 576px) {
            .main-content {
                margin-top: 150px;
                padding: 10px;
            }
            .toolbar-ribbon {
                top: 100px;
            }
            .secondary-nav {
                height: 40px;
            }
            .data-table { min-width: 600px; }
            .data-table th, .data-table td {
                padding: 8px 10px;
                font-size: 0.75rem;
            }
        }

        /* ========== INSPECTION ITEM ROWS ========== */
        .insp-first-row td {
            background: #fff;
        }
        .insp-item-row td {
            background: var(--kt-gray-50, #FCFCFC);
        }

        /* Property row separator - visual gap between properties */
        .data-table tbody > tr.inspection-container + tr:not(.inspection-container) {
            border-top: 8px solid var(--kt-gray-100);
        }

        /* Flagged indicators */
        .flag-yes {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 3px 8px;
            background: var(--kt-danger-light);
            color: var(--kt-danger);
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 4px;
        }
        .flag-no {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 3px 8px;
            background: var(--kt-gray-200);
            color: var(--kt-gray-500);
            font-size: 0.7rem;
            font-weight: 500;
            border-radius: 4px;
        }

        /* ========== SUB-TABLE IMPROVEMENTS ========== */
        /* Property tree container with visual indicator */
        .inspection-container td {
            padding: 0 !important;
            background: #fff;
            position: relative;
            overflow: visible;
        }
        .sub-table-wrapper {
            overflow: visible;
            position: relative;
            margin-left: 24px;
            padding-left: 16px;
            border-left: 2px solid var(--kt-gray-300);
            background: #fff;
        }
        /* Allow tooltips to overflow table rows */
        .sub-table tbody tr {
            overflow: visible;
        }
        .sub-table td {
            overflow: visible;
        }

        /* Sub-table layout */
        .sub-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .sub-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .sub-table thead th {
            background: var(--kt-gray-100);
            padding: 10px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--kt-gray-600);
            border-bottom: 1px solid var(--kt-gray-200);
            white-space: nowrap;
        }

        /* Sub-table cells - Increased height and padding */
        .sub-table td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--kt-gray-100);
            text-align: left;
            vertical-align: middle;
            font-size: 0.8125rem;
            height: 48px;
        }
        .sub-table th {
            text-align: left;
            padding: 12px 12px;
        }
        .sub-table th:first-child,
        .sub-table td:first-child {
            padding-left: 16px;
        }
        .sub-table th:last-child,
        .sub-table td:last-child {
            padding-right: 16px;
            text-align: right;
        }
        .sub-table tbody tr:last-child td {
            border-bottom: none;
        }
        .sub-table tbody tr:hover td {
            background: var(--kt-gray-50, #FCFCFC);
        }

        /* Column widths for proper alignment */
        .sub-table th.col-name, .sub-table td.col-name { width: 200px; text-align: left; }
        .sub-table th.col-date, .sub-table td.col-date { width: 100px; text-align: left; }
        .sub-table th.col-status, .sub-table td.col-status { width: 100px; text-align: left; }
        .sub-table th.col-pdf, .sub-table td.col-pdf { width: 60px; text-align: center; }
        .sub-table th.col-inspector, .sub-table td.col-inspector { width: 120px; text-align: left; }
        .sub-table th.col-section, .sub-table td.col-section { width: 140px; text-align: left; }
        .sub-table th.col-flagged, .sub-table td.col-flagged { width: 80px; text-align: center; }
        .sub-table th.col-rating, .sub-table td.col-rating { width: 80px; text-align: center; }
        .sub-table th.col-cost, .sub-table td.col-cost { width: 100px; text-align: right; }
        .sub-table th.col-total, .sub-table td.col-total { width: 120px; text-align: right; }
        .sub-table th.col-check, .sub-table td.col-check { width: 70px; text-align: center; }
        .sub-table th.col-action, .sub-table td.col-action { width: 120px; text-align: right !important; }

        /* Vertical alignment for rowspan cells */
        .sub-table td[rowspan] {
            vertical-align: top;
            padding-top: 12px;
        }

        /* Action buttons in sub-table */
        .sub-table .action-buttons {
            justify-content: flex-end;
        }

        /* ========== ICON BUTTONS WITH TOOLTIPS ========== */
        .btn-icon-action {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: 1px solid var(--kt-gray-300);
            background: #fff;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }
        .btn-icon-action svg {
            width: 16px;
            height: 16px;
            stroke: var(--kt-gray-600);
        }
        .btn-icon-action:hover {
            background: var(--kt-gray-100);
            border-color: var(--kt-gray-400);
        }
        .btn-icon-action:hover svg {
            stroke: var(--kt-gray-800);
        }
        /* Tooltip */
        .btn-icon-action::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--kt-gray-900);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.6875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
            margin-top: 6px;
            z-index: 9999;
            pointer-events: none;
        }
        .btn-icon-action:hover::after {
            opacity: 1;
            visibility: visible;
        }
        /* View button style */
        .btn-icon-action.view-action {
            background: var(--kt-primary-light);
            border-color: var(--kt-primary-light);
        }
        .btn-icon-action.view-action svg {
            stroke: var(--kt-primary);
        }
        .btn-icon-action.view-action:hover {
            background: var(--kt-primary);
            border-color: var(--kt-primary);
        }
        .btn-icon-action.view-action:hover svg {
            stroke: #fff;
        }
        /* Schedule button style - Theme color */
        .btn-icon-action.schedule-action {
            background: var(--kt-primary-light);
            border-color: var(--kt-primary-light);
        }
        .btn-icon-action.schedule-action svg {
            stroke: var(--kt-primary);
        }
        .btn-icon-action.schedule-action:hover {
            background: var(--kt-primary);
            border-color: var(--kt-primary);
        }
        .btn-icon-action.schedule-action:hover svg {
            stroke: #fff;
        }
        /* Export button style */
        .btn-icon-action.export-action {
            background: rgba(159, 232, 112, 0.2);
            border-color: rgba(159, 232, 112, 0.3);
        }
        .btn-icon-action.export-action svg {
            stroke: var(--kt-primary);
        }
        .btn-icon-action.export-action:hover {
            background: var(--kt-accent);
            border-color: var(--kt-accent);
        }
        /* Action buttons container */
        .action-buttons {
            display: flex;
            gap: 6px;
        }
    </style>
</head>
<body class="sidebar-collapsed">

    <!-- LEFT SIDEBAR -->
    <aside class="sidebar collapsed">
        <div class="sidebar-logo">
            <img src="logo.png" alt="Surveyor Logo">
            <span>surveyor</span>
        </div>
        <nav class="nav-menu">
            <a href="properties-full.html" class="nav-item active" data-title="Home">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span class="nav-text">Home</span>
            </a>
            <a href="#" class="nav-item" data-title="Shared Reports">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                <span class="nav-text">Shared Reports</span>
            </a>
            <a href="#" class="nav-item" data-title="Inspection Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                <span class="nav-text">Inspection Settings</span>
            </a>
            <a href="#" class="nav-item" data-title="Bookings">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span class="nav-text">Bookings</span>
            </a>
            <a href="#" class="nav-item" data-title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                <span class="nav-text">Settings</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <div class="switch-classic">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                <span>Switch to Classic</span>
            </div>
        </div>
    </aside>

    <!-- TOP HEADER -->
    <header class="top-header">
        <div class="header-left">
            <button class="collapse-btn" id="menuToggle">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <a href="properties-full.html" class="header-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>Home</span>
            </a>
        </div>
        <div class="header-right">
            <button class="header-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </button>
            <div class="avatar">K</div>
        </div>
    </header>

    <!-- SECONDARY NAV RIBBON -->
    <nav class="secondary-nav">
        <div class="secondary-nav-left">
            <a href="properties-full.html" class="secondary-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Properties
            </a>
            <a href="summary.html" class="secondary-nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                Summary
            </a>
            <a href="statistics.html" class="secondary-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                Statistics
            </a>
        </div>
    </nav>

    <!-- TOOLBAR RIBBON -->
    <div class="toolbar-ribbon">
        <!-- Search Box - Same as Property screen -->
        <div class="search-box-combined">
            <div class="search-input-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" id="searchInput" placeholder="Search property or inspection...">
            </div>
            <div class="btn-group-infix" role="group">
                <button type="button" class="btn btn-filter active" data-filter="all">All</button>
                <button type="button" class="btn btn-filter" data-filter="property">Property</button>
                <button type="button" class="btn btn-filter" data-filter="inspection">Inspection</button>
            </div>
            <div class="search-divider"></div>
            <button class="btn btn-search" id="searchBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                Search
            </button>
        </div>

        <!-- Filter Group -->
        <div class="filter-group">
            <span class="filter-group-label">Filters</span>

            <!-- Property Columns -->
            <div class="multiselect-wrapper">
                <button class="multiselect-btn" id="propColumnsBtn">
                    Property <span class="multiselect-badge" id="propColumnsCount">0</span>
                </button>
                <div class="multiselect-dropdown" id="propColumnsDropdown">
                    <div style="padding: 8px 14px; font-size: 0.7rem; color: var(--kt-gray-500); border-bottom: 1px solid var(--kt-gray-200);">Property Columns</div>
                    <label class="multiselect-option">
                        <input type="checkbox" value="partner"> Partner
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="branch"> Branch
                    </label>
                </div>
            </div>

            <!-- Inspection Columns with Tree View -->
            <div class="multiselect-wrapper">
                <button class="multiselect-btn" id="inspColumnsBtn">
                    Inspection <span class="multiselect-badge" id="inspColumnsCount">0</span>
                </button>
                <div class="multiselect-dropdown" id="inspColumnsDropdown">
                    <div style="padding: 8px 14px; font-size: 0.7rem; color: var(--kt-gray-500); border-bottom: 1px solid var(--kt-gray-200);">Inspection Columns</div>

                    <!-- Condition Rating Group -->
                    <div class="tree-group">
                        <div class="tree-group-header" data-group="conditionRating">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            <input type="checkbox" id="groupConditionRating">
                            <span>Condition Rating</span>
                        </div>
                        <div class="tree-group-items" id="groupConditionRatingItems">
                            <label class="tree-item">
                                <input type="checkbox" value="section" data-group="conditionRating"> Section
                            </label>
                            <label class="tree-item">
                                <input type="checkbox" value="flagged" data-group="conditionRating"> Flagged
                            </label>
                            <label class="tree-item">
                                <input type="checkbox" value="conditionRating" data-group="conditionRating"> Condition Rating
                            </label>
                            <label class="tree-item">
                                <input type="checkbox" value="cost" data-group="conditionRating"> Cost
                            </label>
                            <label class="tree-item">
                                <input type="checkbox" value="totalCost" data-group="conditionRating"> Total Cost
                            </label>
                        </div>
                    </div>

                    <!-- Flagged Group -->
                    <div class="tree-group">
                        <div class="tree-group-header" data-group="flaggedGroup">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            <input type="checkbox" id="groupFlagged">
                            <span>Flagged</span>
                        </div>
                        <div class="tree-group-items" id="groupFlaggedItems">
                            <label class="tree-item">
                                <input type="checkbox" value="flagSection" data-group="flaggedGroup"> Section
                            </label>
                            <label class="tree-item">
                                <input type="checkbox" value="flagFlagged" data-group="flaggedGroup"> Flagged
                            </label>
                            <label class="tree-item">
                                <input type="checkbox" value="flagCost" data-group="flaggedGroup"> Cost
                            </label>
                            <label class="tree-item">
                                <input type="checkbox" value="flagTotalCost" data-group="flaggedGroup"> Total Cost
                            </label>
                        </div>
                    </div>

                    <!-- Other Columns -->
                    <div style="padding: 8px 14px; font-size: 0.7rem; color: var(--kt-gray-500); border-top: 1px solid var(--kt-gray-200);">Other Columns</div>
                    <label class="multiselect-option">
                        <input type="checkbox" value="sharedReview"> Shared Review
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="commentsBack"> Comments Back
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="sharedEsig"> Shared eSig
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="pdfSigned"> PDF Signed
                    </label>
                </div>
            </div>

            <!-- Status Filter -->
            <div class="multiselect-wrapper">
                <button class="multiselect-btn" id="statusBtn">
                    Status <span class="multiselect-badge" id="statusCount">4</span>
                </button>
                <div class="multiselect-dropdown" id="statusDropdown">
                    <label class="multiselect-option">
                        <input type="checkbox" value="uploaded" checked> Uploaded
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="pending" checked> Pending
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="uploading" checked> Uploading
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="transcribing" checked> Transcribing
                    </label>
                </div>
            </div>

            <!-- Condition Rating Filter (appears when Condition Rating column is selected) -->
            <div class="multiselect-wrapper" id="conditionRatingFilterWrapper" style="display: none;">
                <button class="multiselect-btn" id="conditionRatingBtn">
                    Condition Rating <span class="multiselect-badge" id="conditionRatingCount">5</span>
                </button>
                <div class="multiselect-dropdown" id="conditionRatingDropdown">
                    <div style="padding: 8px 14px; font-size: 0.7rem; color: var(--kt-gray-500); border-bottom: 1px solid var(--kt-gray-200);">Filter by Condition Rating</div>
                    <label class="multiselect-option">
                        <input type="checkbox" value="all" id="conditionRatingAll" checked> All
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="A" checked> Rating A - Good
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="B" checked> Rating B - Fair
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="C" checked> Rating C - Poor
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="D" checked> Rating D - Critical
                    </label>
                </div>
            </div>

            <!-- Divider -->
            <div class="filter-divider"></div>

            <!-- Date Range Section -->
            <div class="date-range-section">
                <select id="dateRangePreset">
                    <option value="1year" selected>Last 1 Year</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="3months">Last 3 Months</option>
                    <option value="6months">Last 6 Months</option>
                    <option value="custom">Custom Range</option>
                </select>
                <div class="custom-date-range" id="customDateRange">
                    <input type="date" id="dateFrom" title="From Date">
                    <span>to</span>
                    <input type="date" id="dateTo" title="To Date">
                </div>
            </div>

            <!-- Divider -->
            <div class="filter-divider"></div>

            <!-- Apply Button - Inside filter group -->
            <button class="btn-apply" id="applyFiltersBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Apply
            </button>
        </div>

        <!-- Spacer to push buttons to right -->
        <div class="toolbar-spacer"></div>

        <!-- Expand All / Collapse All Button - Icon with tooltip -->
        <button class="btn-expand-all" id="expandAllBtn" data-tooltip="Collapse All">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span id="expandAllText">Collapse All</span>
        </button>

        <!-- Export Button - Icon with tooltip -->
        <button class="btn-export" id="exportBtn" data-tooltip="Export">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <span>Export</span>
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div class="card">
            <div class="card-body">
                <div class="table-wrapper">
                    <table class="data-table" id="summaryTable">
                        <thead id="tableHead">
                            <!-- Header rendered by JS -->
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data rendered by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="table-footer" id="tableFooter">
                    <!-- Rows per page selector -->
                    <div class="rows-per-page">
                        <span>Rows per page:</span>
                        <select id="rowsPerPage">
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>

                    <!-- Table info -->
                    <div class="table-info">
                        Showing <strong><span id="showingFrom">1</span></strong> to <strong><span id="showingTo">0</span></strong> of <strong><span id="totalEntries">0</span></strong> properties
                    </div>

                    <!-- Pagination controls -->
                    <div class="pagination" id="pagination">
                        <!-- Rendered by JS -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Chat FAB -->
    <div class="chat-fab">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
        </svg>
    </div>

    <script>
        // Icons - Minimal check (no background)
        const checkIcon = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
        const flagIcon = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>';
        const viewIcon = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
        const exportIcon = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';
        const collapseIcon = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>';

        // Sample data
        const propertiesData = [
            {
                id: 1,
                address: '123 High Street, London',
                postcode: 'SW1A 1AA',
                refCode: 'REF-001',
                project: 'London Portfolio',
                partner: 'ABC Partners',
                branch: 'Central London',
                inspections: [
                    { id: 101, name: 'Annual Inspection', date: '2025-12-15', status: 'uploaded', pdfDone: true, inspector: 'John Smith', items: [{section: 'Wall', flagged: false, rating: 'A', cost: 500}, {section: 'Window', flagged: true, rating: 'B', cost: 1000}, {section: 'Kitchen', flagged: false, rating: 'A', cost: 500}, {section: 'Door', flagged: false, rating: 'C', cost: 1500}, {section: 'Bathroom', flagged: true, rating: 'B', cost: 1000}], nextInspection: '2026-12-15', scheduleFreq: 12, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: true },
                    { id: 102, name: 'Mid-Year Check', date: '2025-06-10', status: 'uploaded', pdfDone: true, inspector: 'Jane Doe', items: [{section: 'Wall', flagged: false, rating: 'A', cost: 500}, {section: 'Ceiling', flagged: false, rating: 'A', cost: 500}, {section: 'Floor', flagged: false, rating: 'B', cost: 1000}, {section: 'Window', flagged: false, rating: 'A', cost: 500}, {section: 'Door', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-06-10', scheduleFreq: 6, sharedReview: true, commentsBack: false, sharedEsig: false, pdfSigned: false }
                ]
            },
            {
                id: 2,
                address: '45 Park Lane, Manchester',
                postcode: 'M1 4BT',
                refCode: 'REF-002',
                project: 'Northern Assets',
                partner: 'XYZ Holdings',
                branch: 'Manchester',
                inspections: [
                    { id: 201, name: 'Quarterly Review', date: '2025-12-01', status: 'pending', pdfDone: false, inspector: 'Mike Wilson', items: [{section: 'Kitchen', flagged: true, rating: 'C', cost: 1500}, {section: 'Bathroom', flagged: true, rating: 'D', cost: 2000}, {section: 'Bedroom', flagged: true, rating: 'C', cost: 1500}, {section: 'Living Room', flagged: false, rating: 'B', cost: 1000}, {section: 'Hallway', flagged: true, rating: 'D', cost: 2000}], nextInspection: '2026-03-01', scheduleFreq: 3, sharedReview: false, commentsBack: false, sharedEsig: false, pdfSigned: false }
                ]
            },
            {
                id: 3,
                address: '78 Queen Street, Edinburgh',
                postcode: 'EH2 3NS',
                refCode: 'REF-003',
                project: 'Scottish Portfolio',
                partner: 'ABC Partners',
                branch: 'Edinburgh',
                inspections: [
                    { id: 301, name: 'Full Survey', date: '2025-06-20', status: 'uploaded', pdfDone: true, inspector: 'Sarah Brown', items: [{section: 'Wall', flagged: false, rating: 'B', cost: 1000}, {section: 'Window', flagged: false, rating: 'A', cost: 500}, {section: 'Roof', flagged: false, rating: 'B', cost: 1000}, {section: 'Foundation', flagged: false, rating: 'A', cost: 500}, {section: 'Garage', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-06-20', scheduleFreq: 12, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: false }
                ]
            },
            {
                id: 4,
                address: '22 Castle Road, Bristol',
                postcode: 'BS1 3AD',
                refCode: 'REF-004',
                project: 'South West Fund',
                partner: 'DEF Capital',
                branch: 'Bristol',
                inspections: [
                    { id: 401, name: 'Initial Assessment', date: '2025-12-10', status: 'transcribing', pdfDone: false, inspector: 'Emily Jones', items: [{section: 'Wall', flagged: false, rating: 'B', cost: 1000}, {section: 'Ceiling', flagged: false, rating: 'A', cost: 500}, {section: 'Floor', flagged: false, rating: 'B', cost: 1000}, {section: 'Kitchen', flagged: false, rating: 'A', cost: 500}, {section: 'Bathroom', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-06-10', scheduleFreq: 6, sharedReview: false, commentsBack: false, sharedEsig: false, pdfSigned: false }
                ]
            },
            {
                id: 5,
                address: '15 Bridge Street, Birmingham',
                postcode: 'B1 2JB',
                refCode: 'REF-005',
                project: 'Midlands Trust',
                partner: 'GHI Investments',
                branch: 'Birmingham',
                inspections: [
                    { id: 501, name: 'Compliance Check', date: '2025-07-28', status: 'uploaded', pdfDone: true, inspector: 'David Lee', items: [{section: 'Fire Safety', flagged: true, rating: 'D', cost: 2000}, {section: 'Electrical', flagged: true, rating: 'C', cost: 1500}, {section: 'Plumbing', flagged: false, rating: 'B', cost: 1000}, {section: 'HVAC', flagged: true, rating: 'C', cost: 1500}, {section: 'Structure', flagged: true, rating: 'D', cost: 2000}], nextInspection: '2026-07-28', scheduleFreq: 3, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: true }
                ]
            }
        ];

        // State
        const expandedRows = new Set();
        const loadingRows = new Set();
        let rowsPerPage = 10;
        let currentPage = 1;
        let searchTerm = '';
        let currentSearchFilter = 'all';
        let currentDateRange = '1year';
        let pendingFilters = false;
        let allExpanded = true; // Default: all expanded

        // Initialize expanded rows with all properties
        propertiesData.forEach(p => expandedRows.add(p.id));

        // Sidebar toggle
        const sidebar = document.querySelector('.sidebar');
        const menuToggle = document.getElementById('menuToggle');

        menuToggle.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
            } else {
                sidebar.classList.toggle('collapsed');
                document.body.classList.toggle('sidebar-collapsed');
            }
        });

        // Search filter buttons (All/Property/Inspection)
        const searchFilterBtns = document.querySelectorAll('.btn-filter');
        const searchInput = document.getElementById('searchInput');
        const placeholders = {
            'all': 'Search property or inspection...',
            'property': 'Search by address, project or reference...',
            'inspection': 'Search by inspection name...'
        };

        searchFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                searchFilterBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSearchFilter = btn.dataset.filter;
                searchInput.placeholder = placeholders[currentSearchFilter];
                searchInput.focus();
                pendingFilters = true;
            });
        });

        // Search input
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            pendingFilters = true;
        });

        // Search button click
        document.getElementById('searchBtn').addEventListener('click', () => {
            currentPage = 1;
            // Keep all expanded - re-expand for filtered results
            expandAllOnCurrentPage();
            renderTable();
            pendingFilters = false;
        });

        // Helper to expand all on current page
        function expandAllOnCurrentPage() {
            const filteredData = getFilteredProperties();
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
            const displayData = filteredData.slice(startIndex, endIndex);
            displayData.forEach(p => expandedRows.add(p.id));
            allExpanded = true;
        }

        // Enter key to search
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        // Date range preset
        const dateRangePreset = document.getElementById('dateRangePreset');
        const customDateRange = document.getElementById('customDateRange');

        dateRangePreset.addEventListener('change', (e) => {
            currentDateRange = e.target.value;
            if (e.target.value === 'custom') {
                customDateRange.classList.add('show');
            } else {
                customDateRange.classList.remove('show');
            }
            pendingFilters = true;
        });

        // Custom date range inputs
        document.getElementById('dateFrom').addEventListener('change', () => { pendingFilters = true; });
        document.getElementById('dateTo').addEventListener('change', () => { pendingFilters = true; });

        // Apply filters button
        document.getElementById('applyFiltersBtn').addEventListener('click', () => {
            currentPage = 1;
            loadingRows.clear();
            // Keep all expanded - re-expand for filtered results
            expandAllOnCurrentPage();
            renderTable();
            pendingFilters = false;
        });

        // Tree group toggle
        document.querySelectorAll('.tree-group-header').forEach(header => {
            header.addEventListener('click', (e) => {
                if (e.target.type === 'checkbox') return;
                header.classList.toggle('collapsed');
                const items = header.nextElementSibling;
                items.classList.toggle('collapsed');
            });

            // Group checkbox
            const groupCheckbox = header.querySelector('input[type="checkbox"]');
            groupCheckbox.addEventListener('change', () => {
                const items = header.nextElementSibling.querySelectorAll('input[type="checkbox"]');
                items.forEach(item => item.checked = groupCheckbox.checked);
                updateInspColumnsCount();
                updateConditionRatingFilterVisibility();
                pendingFilters = true;
            });
        });

        // Individual tree item checkboxes
        document.querySelectorAll('.tree-item input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                updateInspColumnsCount();
                updateConditionRatingFilterVisibility();
                pendingFilters = true;
            });
        });

        function updateInspColumnsCount() {
            const checked = document.querySelectorAll('#inspColumnsDropdown input[type="checkbox"]:checked').length;
            document.getElementById('inspColumnsCount').textContent = checked;
        }

        // Show/hide Condition Rating filter based on column selection
        function updateConditionRatingFilterVisibility() {
            const conditionRatingCheckbox = document.querySelector('#inspColumnsDropdown input[value="conditionRating"]');
            const conditionRatingFilterWrapper = document.getElementById('conditionRatingFilterWrapper');

            if (conditionRatingCheckbox && conditionRatingCheckbox.checked) {
                conditionRatingFilterWrapper.style.display = 'block';
            } else {
                conditionRatingFilterWrapper.style.display = 'none';
            }
        }

        // Update Condition Rating filter count
        function updateConditionRatingCount() {
            const checked = document.querySelectorAll('#conditionRatingDropdown input:not(#conditionRatingAll):checked').length;
            document.getElementById('conditionRatingCount').textContent = checked;
        }

        // Get selected condition ratings for filtering (exclude 'all')
        function getSelectedConditionRatings() {
            return Array.from(document.querySelectorAll('#conditionRatingDropdown input:not(#conditionRatingAll):checked')).map(cb => cb.value);
        }

        // Dropdown handlers
        function setupDropdown(btnId, dropdownId) {
            const btn = document.getElementById(btnId);
            const dropdown = document.getElementById(dropdownId);
            if (!btn || !dropdown) return;

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                btn.classList.toggle('active');
                dropdown.classList.toggle('show');
                document.querySelectorAll('.multiselect-dropdown').forEach(d => {
                    if (d !== dropdown) d.classList.remove('show');
                });
                document.querySelectorAll('.multiselect-btn').forEach(b => {
                    if (b !== btn) b.classList.remove('active');
                });
            });
        }

        setupDropdown('propColumnsBtn', 'propColumnsDropdown');
        setupDropdown('inspColumnsBtn', 'inspColumnsDropdown');
        setupDropdown('statusBtn', 'statusDropdown');
        setupDropdown('conditionRatingBtn', 'conditionRatingDropdown');

        // Close dropdowns on outside click
        document.addEventListener('click', () => {
            document.querySelectorAll('.multiselect-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.multiselect-btn').forEach(b => b.classList.remove('active'));
        });

        // Filter checkbox handlers
        document.querySelectorAll('#propColumnsDropdown input, #statusDropdown input').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                pendingFilters = true;
                // Update counts
                const propCount = document.querySelectorAll('#propColumnsDropdown input:checked').length;
                const statusCount = document.querySelectorAll('#statusDropdown input:checked').length;
                document.getElementById('propColumnsCount').textContent = propCount;
                document.getElementById('statusCount').textContent = statusCount;
            });
        });

        // Condition Rating filter checkbox handlers
        const conditionRatingAllCheckbox = document.getElementById('conditionRatingAll');
        const conditionRatingCheckboxes = document.querySelectorAll('#conditionRatingDropdown input:not(#conditionRatingAll)');

        conditionRatingAllCheckbox.addEventListener('change', () => {
            const isChecked = conditionRatingAllCheckbox.checked;
            conditionRatingCheckboxes.forEach(cb => cb.checked = isChecked);
            pendingFilters = true;
            updateConditionRatingCount();
        });

        conditionRatingCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                // Update "All" checkbox based on individual selections
                const allChecked = Array.from(conditionRatingCheckboxes).every(cb => cb.checked);
                const noneChecked = Array.from(conditionRatingCheckboxes).every(cb => !cb.checked);
                conditionRatingAllCheckbox.checked = allChecked;
                conditionRatingAllCheckbox.indeterminate = !allChecked && !noneChecked;
                pendingFilters = true;
                updateConditionRatingCount();
            });
        });

        // Get filtered properties
        function getFilteredProperties() {
            let filtered = [...propertiesData];

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(p =>
                    p.address.toLowerCase().includes(term) ||
                    p.postcode.toLowerCase().includes(term) ||
                    p.refCode.toLowerCase().includes(term) ||
                    p.project.toLowerCase().includes(term)
                );
            }

            // Status filter
            const selectedStatuses = Array.from(document.querySelectorAll('#statusDropdown input:checked')).map(cb => cb.value);
            if (selectedStatuses.length > 0 && selectedStatuses.length < 4) {
                filtered = filtered.filter(p =>
                    p.inspections.some(i => selectedStatuses.includes(i.status))
                );
            }

            return filtered;
        }

        // Check if condition rating filter is active
        function isConditionRatingFilterActive() {
            const conditionRatingCheckbox = document.querySelector('#inspColumnsDropdown input[value="conditionRating"]');
            return conditionRatingCheckbox && conditionRatingCheckbox.checked;
        }

        // Get filtered items based on condition rating
        function getFilteredItems(items) {
            if (!isConditionRatingFilterActive()) {
                return items;
            }
            const selectedRatings = getSelectedConditionRatings();
            if (selectedRatings.length === 4) {
                return items; // All selected, no filtering needed
            }
            return items.filter(item => selectedRatings.includes(item.rating));
        }

        // Get inspection cost (filtered by condition rating if active)
        function getInspectionCost(inspection) {
            const filteredItems = getFilteredItems(inspection.items);
            return filteredItems.reduce((sum, item) => sum + item.cost, 0);
        }

        // Get inspection cost (unfiltered - for comparison)
        function getInspectionCostUnfiltered(inspection) {
            return inspection.items.reduce((sum, item) => sum + item.cost, 0);
        }

        // Get property cost
        function getPropertyCost(property) {
            return property.inspections.reduce((sum, insp) => sum + getInspectionCost(insp), 0);
        }

        // Get filtered item count for an inspection
        function getFilteredItemCount(inspection) {
            return getFilteredItems(inspection.items).length;
        }

        // Skeleton HTML
        function getSkeletonHtml() {
            return `
                <div class="skeleton-sub-table">
                    <div class="skeleton-row"><div class="skeleton skeleton-cell w-120"></div><div class="skeleton skeleton-cell w-80"></div><div class="skeleton skeleton-cell w-60"></div><div class="skeleton skeleton-cell w-80"></div></div>
                    <div class="skeleton-row"><div class="skeleton skeleton-cell w-120"></div><div class="skeleton skeleton-cell w-80"></div><div class="skeleton skeleton-cell w-60"></div><div class="skeleton skeleton-cell w-80"></div></div>
                </div>
            `;
        }

        // Capitalize
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Render table
        function renderTable() {
            const showPartner = document.querySelector('#propColumnsDropdown input[value="partner"]')?.checked;
            const showBranch = document.querySelector('#propColumnsDropdown input[value="branch"]')?.checked;

            // Header
            const thead = document.getElementById('tableHead');
            thead.innerHTML = `
                <tr>
                    <th>Address</th>
                    <th>Postcode</th>
                    <th>Ref Code</th>
                    <th>Project</th>
                    ${showPartner ? '<th>Partner</th>' : ''}
                    ${showBranch ? '<th>Branch</th>' : ''}
                    <th style="width: 180px;">Actions</th>
                </tr>
            `;

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const filteredData = getFilteredProperties();
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);

            // Ensure current page is valid
            if (currentPage > totalPages) currentPage = totalPages || 1;

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
            const displayData = filteredData.slice(startIndex, endIndex);

            // Update pagination info
            document.getElementById('showingFrom').textContent = filteredData.length > 0 ? startIndex + 1 : 0;
            document.getElementById('showingTo').textContent = endIndex;
            document.getElementById('totalEntries').textContent = filteredData.length;

            // Render pagination
            renderPagination(totalPages);

            const propColCount = 4 + (showPartner ? 1 : 0) + (showBranch ? 1 : 0) + 1;

            displayData.forEach(property => {
                const isExpanded = expandedRows.has(property.id);
                const isLoading = loadingRows.has(property.id);

                const row = document.createElement('tr');
                if (isExpanded) {
                    row.className = 'property-expanded';
                }
                row.innerHTML = `
                    <td><span class="cell-text">${property.address}</span><span class="property-count">${property.inspections.length}</span></td>
                    <td>${property.postcode}</td>
                    <td>${property.refCode}</td>
                    <td>${property.project}</td>
                    ${showPartner ? `<td>${property.partner}</td>` : ''}
                    ${showBranch ? `<td>${property.branch}</td>` : ''}
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon-action ${isExpanded ? 'view-action' : ''}" onclick="toggleExpand(${property.id})" data-tooltip="${isExpanded ? 'Collapse' : 'Expand'}">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: ${isExpanded ? 'rotate(180deg)' : 'rotate(0)'};transition:transform 0.2s;">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <button class="btn-icon-action export-action" onclick="exportProperty(${property.id})" data-tooltip="Export">
                                ${exportIcon}
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);

                // Inspection sub-table
                if (isExpanded || isLoading) {
                    const containerRow = document.createElement('tr');
                    containerRow.className = 'inspection-container';

                    if (isLoading) {
                        containerRow.innerHTML = `<td colspan="${propColCount}">${getSkeletonHtml()}</td>`;
                    } else {
                        const conditionRatingActive = isConditionRatingFilterActive();
                        const selectedRatings = getSelectedConditionRatings();
                        const isFiltered = conditionRatingActive && selectedRatings.length < 4;

                        // Get selected inspection columns for item details
                        const showSection = document.querySelector('#inspColumnsDropdown input[value="section"]')?.checked;
                        const showFlagged = document.querySelector('#inspColumnsDropdown input[value="flagged"]')?.checked;
                        const showConditionRating = document.querySelector('#inspColumnsDropdown input[value="conditionRating"]')?.checked;
                        const showCost = document.querySelector('#inspColumnsDropdown input[value="cost"]')?.checked;
                        const showTotalCost = document.querySelector('#inspColumnsDropdown input[value="totalCost"]')?.checked;
                        const showSharedReview = document.querySelector('#inspColumnsDropdown input[value="sharedReview"]')?.checked;
                        const showCommentsBack = document.querySelector('#inspColumnsDropdown input[value="commentsBack"]')?.checked;
                        const showSharedEsig = document.querySelector('#inspColumnsDropdown input[value="sharedEsig"]')?.checked;
                        const showPdfSigned = document.querySelector('#inspColumnsDropdown input[value="pdfSigned"]')?.checked;

                        // Check if any item detail columns are selected
                        const showItemDetails = showSection || showFlagged || showConditionRating || showCost;

                        // Build headers
                        let inspHeaders = '<th class="col-name">Inspection</th><th class="col-date">Date</th><th class="col-status">Status</th><th class="col-pdf">PDF</th><th class="col-inspector">Inspector</th>';
                        if (showSection) inspHeaders += '<th class="col-section">Section</th>';
                        if (showFlagged) inspHeaders += '<th class="col-flagged">Flagged</th>';
                        if (showConditionRating) inspHeaders += '<th class="col-rating">Rating</th>';
                        if (showCost) inspHeaders += '<th class="col-cost">Cost</th>';
                        if (showTotalCost) inspHeaders += '<th class="col-total">Total</th>';
                        if (showSharedReview) inspHeaders += '<th class="col-check">Review</th>';
                        if (showCommentsBack) inspHeaders += '<th class="col-check">Comments</th>';
                        if (showSharedEsig) inspHeaders += '<th class="col-check">eSig</th>';
                        if (showPdfSigned) inspHeaders += '<th class="col-check">Signed</th>';
                        inspHeaders += '<th class="col-action">Actions</th>';

                        // Count columns for footer
                        let totalColCount = 5;
                        if (showSection) totalColCount++;
                        if (showFlagged) totalColCount++;
                        if (showConditionRating) totalColCount++;
                        if (showCost) totalColCount++;
                        if (showTotalCost) totalColCount++;
                        if (showSharedReview) totalColCount++;
                        if (showCommentsBack) totalColCount++;
                        if (showSharedEsig) totalColCount++;
                        if (showPdfSigned) totalColCount++;
                        totalColCount++; // action column

                        let inspHtml = '';
                        property.inspections.forEach(insp => {
                            const filteredItems = getFilteredItems(insp.items);
                            const filteredCost = getInspectionCost(insp);
                            const totalCost = getInspectionCostUnfiltered(insp);

                            // Determine how many rows this inspection will have
                            const itemRows = showItemDetails ? filteredItems : [null]; // at least one row

                            itemRows.forEach((item, itemIndex) => {
                                const isFirstRow = itemIndex === 0;
                                const rowSpan = showItemDetails ? filteredItems.length : 1;

                                inspHtml += `<tr class="${isFirstRow ? 'insp-first-row' : 'insp-item-row'}">`;

                                // Base columns - only on first row with rowspan
                                if (isFirstRow) {
                                    inspHtml += `
                                        <td rowspan="${rowSpan}"><span class="cell-text">${insp.name}</span></td>
                                        <td rowspan="${rowSpan}">${insp.date}</td>
                                        <td rowspan="${rowSpan}"><span class="cell-status ${insp.status}">${capitalizeFirst(insp.status)}</span></td>
                                        <td rowspan="${rowSpan}"><span class="cell-check ${insp.pdfDone ? '' : 'empty'}">${checkIcon}</span></td>
                                        <td rowspan="${rowSpan}">${insp.inspector}</td>`;
                                }

                                // Item detail columns - each row
                                if (showItemDetails && item) {
                                    if (showSection) inspHtml += `<td class="col-section">${item.section}</td>`;
                                    if (showFlagged) inspHtml += `<td class="col-flagged">${item.flagged ? '<span class="flag-yes">Yes</span>' : '<span class="flag-no">No</span>'}</td>`;
                                    if (showConditionRating) inspHtml += `<td class="col-rating"><span class="condition-badge rating-${item.rating.toLowerCase()}">${item.rating}</span></td>`;
                                    if (showCost) inspHtml += `<td class="col-cost cost-value">${item.cost.toFixed(2)}</td>`;
                                }

                                // Summary columns - only on first row
                                if (isFirstRow) {
                                    let costDisplay = `${filteredCost.toFixed(2)}`;
                                    if (isFiltered && filteredCost !== totalCost) {
                                        costDisplay = `<span class="filtered-cost">${filteredCost.toFixed(2)}</span><span class="total-cost-ref">/ ${totalCost.toFixed(2)}</span>`;
                                    }
                                    if (showTotalCost) inspHtml += `<td rowspan="${rowSpan}" class="cost-value">${costDisplay}</td>`;
                                    if (showSharedReview) inspHtml += `<td rowspan="${rowSpan}"><span class="cell-check ${insp.sharedReview ? '' : 'empty'}">${checkIcon}</span></td>`;
                                    if (showCommentsBack) inspHtml += `<td rowspan="${rowSpan}"><span class="cell-check ${insp.commentsBack ? '' : 'empty'}">${checkIcon}</span></td>`;
                                    if (showSharedEsig) inspHtml += `<td rowspan="${rowSpan}"><span class="cell-check ${insp.sharedEsig ? '' : 'empty'}">${checkIcon}</span></td>`;
                                    if (showPdfSigned) inspHtml += `<td rowspan="${rowSpan}"><span class="cell-check ${insp.pdfSigned ? '' : 'empty'}">${checkIcon}</span></td>`;
                                    inspHtml += `<td rowspan="${rowSpan}">
                                        <div class="action-buttons">
                                            <button class="btn-icon-action view-action" onclick="viewInspection(${insp.id})" data-tooltip="View">
                                                ${viewIcon}
                                            </button>
                                            <button class="btn-icon-action schedule-action" onclick="scheduleInspection(${insp.id})" data-tooltip="Schedule">
                                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                                </svg>
                                            </button>
                                            <button class="btn-icon-action" onclick="toggleRow(${property.id})" data-tooltip="Collapse">
                                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="18 15 12 9 6 15"></polyline>
                                                </svg>
                                            </button>
                                        </div>
                                    </td>`;
                                }

                                inspHtml += '</tr>';
                            });
                        });

                        // Check if Condition or Flagged group is selected (show Property Total only then)
                        const conditionGroupSelected = document.getElementById('groupConditionRating')?.checked;
                        const flaggedGroupSelected = document.getElementById('groupFlagged')?.checked;
                        const showPropertyTotal = conditionGroupSelected || flaggedGroupSelected;

                        // Calculate totals for footer
                        const totalFilteredCost = property.inspections.reduce((sum, insp) => sum + getInspectionCost(insp), 0);
                        const totalUnfilteredCost = property.inspections.reduce((sum, insp) => sum + getInspectionCostUnfiltered(insp), 0);
                        let totalCostDisplay = `${totalFilteredCost.toFixed(2)}`;
                        if (isFiltered && totalFilteredCost !== totalUnfilteredCost) {
                            totalCostDisplay = `<span class="filtered-cost">${totalFilteredCost.toFixed(2)}</span><span class="total-cost-ref">/ ${totalUnfilteredCost.toFixed(2)}</span>`;
                        }

                        // Filter indicator
                        let filterIndicator = '';
                        if (isFiltered) {
                            const ratingBadges = selectedRatings.map(r => `<span class="rating-badge-mini rating-${r.toLowerCase()}">${r}</span>`).join('');
                            filterIndicator = `<div class="filter-indicator">Filtered by: ${ratingBadges}</div>`;
                        }

                        // Property Total footer - only show when Condition or Flagged group selected
                        const footerHtml = showPropertyTotal ? `
                            <tfoot>
                                <tr class="totals-row">
                                    <td colspan="${totalColCount - 2}"><strong>Property Total</strong></td>
                                    <td class="cost-value"><strong>${totalCostDisplay}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        ` : '';

                        containerRow.innerHTML = `
                            <td colspan="${propColCount}">
                                <div class="sub-table-wrapper">
                                    ${filterIndicator}
                                    <table class="sub-table">
                                        <thead>
                                            <tr>${inspHeaders}</tr>
                                        </thead>
                                        <tbody>${inspHtml}</tbody>
                                        ${footerHtml}
                                    </table>
                                </div>
                            </td>
                        `;
                    }
                    tbody.appendChild(containerRow);
                }
            });
        }

        // Toggle expand
        function toggleExpand(propertyId) {
            if (expandedRows.has(propertyId)) {
                expandedRows.delete(propertyId);
                loadingRows.delete(propertyId);
                renderTable();
            } else {
                loadingRows.add(propertyId);
                renderTable();
                setTimeout(() => {
                    loadingRows.delete(propertyId);
                    expandedRows.add(propertyId);
                    renderTable();
                }, 600);
            }
        }

        // View inspection
        function viewInspection(inspectionId) {
            alert('Viewing inspection: ' + inspectionId);
        }

        // Schedule inspection
        function scheduleInspection(inspectionId) {
            alert('Scheduling inspection: ' + inspectionId);
        }

        // Export property
        function exportProperty(propertyId) {
            const prop = propertiesData.find(p => p.id === propertyId);
            if (prop) {
                alert('Exporting: ' + prop.address);
            }
        }

        // Render pagination - Always show even with few items
        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            // Always show at least 3 pages for UI demo
            const displayPages = Math.max(totalPages, 3);

            let html = '';

            // Previous button
            html += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>`;

            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(displayPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // First page + ellipsis
            if (startPage > 1) {
                html += `<button class="pagination-btn" onclick="goToPage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const isDisabled = i > totalPages ? 'disabled' : '';
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})" ${isDisabled}>${i}</button>`;
            }

            // Last page + ellipsis
            if (endPage < displayPages) {
                if (endPage < displayPages - 1) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
                const isDisabled = displayPages > totalPages ? 'disabled' : '';
                html += `<button class="pagination-btn" onclick="goToPage(${displayPages})" ${isDisabled}>${displayPages}</button>`;
            }

            // Next button
            html += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>`;

            pagination.innerHTML = html;
        }

        // Go to page
        function goToPage(page) {
            currentPage = page;
            loadingRows.clear();
            // Keep all expanded on new page
            expandAllOnCurrentPage();
            renderTable();
        }

        // Rows per page change
        document.getElementById('rowsPerPage').addEventListener('change', (e) => {
            rowsPerPage = parseInt(e.target.value);
            currentPage = 1;
            loadingRows.clear();
            // Keep all expanded
            expandAllOnCurrentPage();
            renderTable();
        });

        // Expand All / Collapse All button
        document.getElementById('expandAllBtn').addEventListener('click', () => {
            const btn = document.getElementById('expandAllBtn');
            const textSpan = document.getElementById('expandAllText');
            const filteredData = getFilteredProperties();
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
            const displayData = filteredData.slice(startIndex, endIndex);

            if (allExpanded) {
                // Collapse all
                expandedRows.clear();
                loadingRows.clear();
                allExpanded = false;
                btn.classList.add('collapsed');
                textSpan.textContent = 'Expand All';
                btn.setAttribute('data-tooltip', 'Expand All');
            } else {
                // Expand all on current page
                displayData.forEach(p => expandedRows.add(p.id));
                allExpanded = true;
                btn.classList.remove('collapsed');
                textSpan.textContent = 'Collapse All';
                btn.setAttribute('data-tooltip', 'Collapse All');
            }
            renderTable();
        });

        // Update expand button state after page changes
        function updateExpandButtonState() {
            const btn = document.getElementById('expandAllBtn');
            const textSpan = document.getElementById('expandAllText');
            const filteredData = getFilteredProperties();
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
            const displayData = filteredData.slice(startIndex, endIndex);

            const allOnPageExpanded = displayData.every(p => expandedRows.has(p.id));
            if (allOnPageExpanded && displayData.length > 0) {
                allExpanded = true;
                btn.classList.remove('collapsed');
                textSpan.textContent = 'Collapse All';
                btn.setAttribute('data-tooltip', 'Collapse All');
            } else {
                allExpanded = false;
                btn.classList.add('collapsed');
                textSpan.textContent = 'Expand All';
                btn.setAttribute('data-tooltip', 'Expand All');
            }
        }

        // Initial render
        renderTable();
    </script>
</body>
</html>
