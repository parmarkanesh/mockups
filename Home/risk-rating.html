<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surveyor - Risk Rating</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --kt-primary: #163300;
            --kt-primary-light: #EEE6DA;
            --kt-accent: #9FE870;
            --kt-success: #50CD89;
            --kt-success-light: #E8FFF3;
            --kt-warning: #FFC700;
            --kt-warning-light: #FFF8DD;
            --kt-danger: #F1416C;
            --kt-danger-light: #FFF5F8;
            --kt-info: #7239EA;
            --kt-gray-100: #F9F9F9;
            --kt-gray-200: #F1F1F2;
            --kt-gray-300: #E1E3EA;
            --kt-gray-400: #B5B5C3;
            --kt-gray-500: #A1A5B7;
            --kt-gray-600: #7E8299;
            --kt-gray-700: #5E6278;
            --kt-gray-800: #3F4254;
            --kt-gray-900: #181C32;
            --sidebar-width: 220px;
            --rating-a: #50CD89;
            --rating-b: #FFC700;
            --rating-c: #F6B100;
            --rating-d: #F1416C;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fff;
            min-height: 100vh;
        }

        /* ========== LEFT SIDEBAR ========== */
        .sidebar {
            width: var(--sidebar-width);
            background: #fff;
            border-right: 1px solid var(--kt-gray-200);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width 0.25s ease;
        }

        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: 11px; }
        .sidebar.collapsed .nav-text, .sidebar.collapsed .chevron { display: none; }
        .sidebar.collapsed .nav-item { position: relative; }
        .sidebar.collapsed .nav-item::after {
            content: attr(data-title);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: var(--kt-gray-900);
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            margin-left: 10px;
            z-index: 1000;
        }
        .sidebar.collapsed .nav-item:hover::after { opacity: 1; visibility: visible; }
        .sidebar.collapsed .nav-item svg { margin: 0; }
        .sidebar.collapsed .switch-classic { justify-content: center; padding: 10px; }
        .sidebar.collapsed .switch-classic span { display: none; }
        .switch-classic span { white-space: nowrap; overflow: hidden; }

        body.sidebar-collapsed .top-header { left: 70px; }
        body.sidebar-collapsed .secondary-nav { left: 70px; }
        body.sidebar-collapsed .toolbar-ribbon { left: 70px; }
        body.sidebar-collapsed .main-content { margin-left: 70px; }

        .sidebar-logo {
            padding: 15px 16px;
            border-bottom: 1px solid var(--kt-gray-200);
            display: flex;
            align-items: center;
            gap: 10px;
            height: 60px;
        }
        .sidebar-logo img { width: 32px; height: 32px; border-radius: 6px; }
        .sidebar.collapsed .sidebar-logo { justify-content: center; padding: 15px 10px; }
        .sidebar.collapsed .sidebar-logo img { width: 40px; height: 40px; }
        .sidebar.collapsed .sidebar-logo span { display: none; }
        .sidebar-logo span { font-size: 1.1rem; font-weight: 600; color: #50cd89; }

        .nav-menu { padding: 12px 10px; flex: 1; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 14px;
            border-radius: 6px;
            color: var(--kt-gray-700);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 2px;
            user-select: none;
        }
        .nav-item:hover { background: var(--kt-gray-100); color: var(--kt-gray-900); }
        .nav-item:active { transform: scale(0.98); }
        .nav-item.active { background: var(--kt-primary-light); color: var(--kt-primary); }
        .nav-item.active:hover { background: var(--kt-primary-light); }
        .nav-item svg { width: 18px; height: 18px; stroke: currentColor; flex-shrink: 0; }
        .nav-text { flex: 1; white-space: nowrap; overflow: hidden; }
        .nav-item .chevron { margin-left: auto; width: 16px; height: 16px; stroke: var(--kt-gray-400); }

        .sidebar-footer { padding: 16px; border-top: 1px solid var(--kt-gray-200); }
        .switch-classic {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--kt-gray-100);
            border-radius: 6px;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            cursor: pointer;
        }
        .switch-classic svg { width: 18px; height: 18px; stroke: #17a388; }

        /* ========== TOP HEADER ========== */
        .top-header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: 60px;
            background: #fff;
            border-bottom: 1px solid var(--kt-gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 99;
            transition: left 0.25s ease;
        }
        .header-left { display: flex; align-items: center; gap: 8px; }
        .collapse-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--kt-gray-500);
        }
        .header-nav-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--kt-gray-700);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s;
        }
        .header-nav-item:hover { color: var(--kt-primary); }
        .header-nav-item svg { width: 16px; height: 16px; stroke: currentColor; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--kt-gray-100);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--kt-gray-600);
        }
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--kt-gray-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--kt-gray-700);
            font-size: 0.875rem;
        }

        /* ========== SECONDARY NAV RIBBON ========== */
        .secondary-nav {
            position: fixed;
            top: 60px;
            left: var(--sidebar-width);
            right: 0;
            height: 50px;
            background: #fff;
            border-bottom: 1px solid var(--kt-gray-200);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 20px;
            gap: 16px;
            z-index: 98;
            transition: left 0.25s ease;
        }
        .secondary-nav-left { display: flex; align-items: center; gap: 8px; }
        .secondary-nav-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 5px;
            color: var(--kt-gray-600);
            text-decoration: none;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: all 0.15s;
        }
        .secondary-nav-item:hover { background: var(--kt-gray-100); color: var(--kt-gray-800); }
        .secondary-nav-item.active { background: var(--kt-primary-light); color: var(--kt-primary); }
        .secondary-nav-item svg { width: 16px; height: 16px; stroke: currentColor; }

        /* ========== TOOLBAR RIBBON ========== */
        .toolbar-ribbon {
            position: fixed;
            top: 110px;
            left: var(--sidebar-width);
            right: 0;
            height: 56px;
            background: #fff;
            border-bottom: 1px solid var(--kt-gray-200);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 12px;
            z-index: 97;
            transition: left 0.25s ease;
        }

        /* Search Box */
        .toolbar-search {
            display: flex;
            align-items: center;
            background: var(--kt-gray-100);
            border: 1px solid var(--kt-gray-300);
            border-radius: 6px;
            overflow: hidden;
            min-width: 320px;
            height: 38px;
        }
        .toolbar-search:focus-within {
            border-color: var(--kt-primary);
            box-shadow: 0 0 0 3px var(--kt-primary-light);
        }
        .toolbar-search input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0 12px;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            outline: none;
            height: 100%;
        }
        .toolbar-search input::placeholder { color: var(--kt-gray-400); }
        .toolbar-search-btn {
            width: 38px;
            height: 100%;
            background: var(--kt-primary);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            transition: background 0.15s;
        }
        .toolbar-search-btn:hover { background: #0f2200; }
        .toolbar-search-btn svg { width: 16px; height: 16px; stroke: currentColor; }

        /* Multi-select dropdown */
        .multiselect-wrapper {
            position: relative;
            height: 38px;
        }
        .multiselect-btn {
            height: 100%;
            padding: 0 32px 0 12px;
            border: 1px solid var(--kt-gray-300);
            border-radius: 6px;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237E8299' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") right 10px center no-repeat;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            cursor: pointer;
            min-width: 140px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }
        .multiselect-btn:hover { border-color: var(--kt-gray-400); }
        .multiselect-btn.active {
            border-color: var(--kt-primary);
            box-shadow: 0 0 0 3px var(--kt-primary-light);
        }
        .multiselect-badge {
            background: var(--kt-primary);
            color: #fff;
            font-size: 0.6875rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .multiselect-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            min-width: 200px;
            background: #fff;
            border: 1px solid var(--kt-gray-300);
            border-radius: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
            max-height: 280px;
            overflow-y: auto;
        }
        .multiselect-dropdown.show { display: block; }
        .multiselect-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            transition: background 0.15s;
        }
        .multiselect-option:hover { background: var(--kt-gray-100); }
        .multiselect-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--kt-primary);
            cursor: pointer;
        }

        /* Risk Rating Badge in dropdown */
        .rating-badge-option {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #fff;
            margin-right: 8px;
        }
        .rating-badge-option.rating-a { background: var(--rating-a); }
        .rating-badge-option.rating-b { background: var(--rating-b); }
        .rating-badge-option.rating-c { background: var(--rating-c); }
        .rating-badge-option.rating-d { background: var(--rating-d); }

        /* Date Filter Dropdown */
        .date-filter-wrapper {
            position: relative;
            height: 38px;
        }
        .date-filter-btn {
            height: 100%;
            padding: 0 32px 0 12px;
            border: 1px solid var(--kt-gray-300);
            border-radius: 6px;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237E8299' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") right 10px center no-repeat;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            cursor: pointer;
            min-width: 150px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }
        .date-filter-btn:hover { border-color: var(--kt-gray-400); }
        .date-filter-btn.active {
            border-color: var(--kt-primary);
            box-shadow: 0 0 0 3px var(--kt-primary-light);
        }
        .date-filter-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            min-width: 200px;
            background: #fff;
            border: 1px solid var(--kt-gray-300);
            border-radius: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .date-filter-dropdown.show { display: block; }
        .date-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            transition: background 0.15s;
        }
        .date-option:hover { background: var(--kt-gray-100); }
        .date-option.selected { background: var(--kt-primary-light); color: var(--kt-primary); }
        .date-option svg { width: 16px; height: 16px; stroke: currentColor; }
        .date-option-divider {
            height: 1px;
            background: var(--kt-gray-200);
            margin: 4px 0;
        }
        .date-custom-range {
            padding: 12px 14px;
            border-top: 1px solid var(--kt-gray-200);
        }
        .date-custom-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--kt-gray-600);
            margin-bottom: 10px;
        }
        .date-custom-inputs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .date-input-group {
            flex: 1;
        }
        .date-input-group label {
            display: block;
            font-size: 0.6875rem;
            color: var(--kt-gray-500);
            margin-bottom: 4px;
        }
        .date-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--kt-gray-300);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--kt-gray-700);
            background: #fff;
        }
        .date-input:focus {
            outline: none;
            border-color: var(--kt-primary);
            box-shadow: 0 0 0 2px var(--kt-primary-light);
        }
        .date-apply-btn {
            width: 100%;
            padding: 8px 12px;
            background: var(--kt-primary);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s;
        }
        .date-apply-btn:hover {
            background: #0f2200;
        }

        /* Entries per page */
        .toolbar-control {
            position: relative;
            height: 38px;
        }
        .toolbar-select {
            height: 100%;
            padding: 0 32px 0 12px;
            border: 1px solid var(--kt-gray-300);
            border-radius: 6px;
            background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237E8299' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") right 10px center no-repeat;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            cursor: pointer;
            appearance: none;
            min-width: 130px;
            transition: all 0.15s;
        }
        .toolbar-select:hover { border-color: var(--kt-gray-400); }
        .toolbar-select:focus {
            outline: none;
            border-color: var(--kt-primary);
            box-shadow: 0 0 0 3px var(--kt-primary-light);
        }

        /* Export Button */
        .btn-export {
            height: 38px;
            padding: 0 16px;
            background: var(--kt-primary);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.15s;
        }
        .btn-export:hover { background: #0f2200; }
        .btn-export svg { width: 16px; height: 16px; stroke: currentColor; }

        .toolbar-spacer { flex: 1; }

        /* Tooltip - BOTTOM position */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]::before {
            content: attr(data-tooltip);
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--kt-gray-900);
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.6875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            z-index: 1001;
            pointer-events: none;
        }
        [data-tooltip]::after {
            content: '';
            position: absolute;
            top: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-bottom-color: var(--kt-gray-900);
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            pointer-events: none;
        }
        [data-tooltip]:hover::before,
        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: 166px;
            min-height: calc(100vh - 166px);
            transition: margin-left 0.25s ease;
            background: var(--kt-gray-100);
            padding: 20px;
        }

        /* ========== DATA TABLE ========== */
        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            position: relative;
        }
        .card-body { padding: 0; }

        .table-wrapper {
            overflow-x: auto;
            position: relative;
        }

        .data-table {
            width: 100%;
            min-width: 1400px;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }
        .data-table th {
            background: var(--kt-gray-100);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--kt-gray-600);
            border-bottom: 1px solid var(--kt-gray-200);
            white-space: nowrap;
            position: relative;
        }
        .data-table th.sortable {
            cursor: pointer;
            user-select: none;
        }
        .data-table th.sortable:hover { color: var(--kt-gray-800); }
        .data-table th .sort-icon {
            display: inline-block;
            margin-left: 4px;
            opacity: 0.4;
        }
        .data-table th.sorted .sort-icon { opacity: 1; color: var(--kt-primary); }
        .data-table th.sorted.asc .sort-icon::after { content: '↑'; }
        .data-table th.sorted.desc .sort-icon::after { content: '↓'; }
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--kt-gray-200);
            color: var(--kt-gray-700);
            vertical-align: middle;
            white-space: nowrap;
        }
        .data-table tbody tr:hover { background: var(--kt-gray-100); }
        .data-table tbody tr:last-child td { border-bottom: none; }

        /* Property Row (Parent) */
        .property-row {
            background: #fff;
            cursor: pointer;
            transition: background 0.15s;
        }
        .property-row:hover { background: var(--kt-gray-100); }
        .property-row.expanded { background: var(--kt-primary-light); }
        .property-row td { font-weight: 500; }

        /* Expand Button */
        .expand-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--kt-gray-300);
            background: #fff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }
        .expand-btn:hover {
            background: var(--kt-primary);
            border-color: var(--kt-primary);
            color: #fff;
        }
        .expand-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            transition: transform 0.2s;
        }
        .property-row.expanded .expand-btn svg {
            transform: rotate(180deg);
        }
        .property-row.expanded .expand-btn {
            background: var(--kt-primary);
            border-color: var(--kt-primary);
            color: #fff;
        }

        /* Inspection Sub-rows Container */
        .inspection-container {
            background: var(--kt-gray-100);
        }
        .inspection-container > td {
            padding: 16px 16px 16px 48px !important;
            border-bottom: 1px solid var(--kt-gray-300) !important;
        }

        /* Sub-table wrapper for horizontal scroll */
        .sub-table-wrapper {
            overflow-x: auto;
            margin-right: 16px;
        }

        /* Sub-table for inspections */
        .sub-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
            background: #fff;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .sub-table th {
            background: var(--kt-gray-200);
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--kt-gray-600);
            border-bottom: 1px solid var(--kt-gray-300);
            white-space: nowrap;
        }
        .sub-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--kt-gray-200);
            color: var(--kt-gray-700);
            vertical-align: middle;
            white-space: nowrap;
        }
        .sub-table tbody tr:hover {
            background: var(--kt-gray-100);
        }
        .sub-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Summary row in sub-table */
        .sub-table .summary-row {
            background: var(--kt-gray-100);
        }
        .sub-table .summary-row td {
            font-weight: 500;
            border-top: 2px solid var(--kt-gray-300);
        }

        /* Sub-row indicator */
        .sub-row-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 8px;
            color: var(--kt-gray-400);
        }

        /* Table Cell Styles */
        .cell-link {
            color: var(--kt-primary);
            text-decoration: none;
            font-weight: 500;
        }
        .cell-link:hover { text-decoration: underline; }

        .cell-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .cell-status.pending { background: var(--kt-warning-light); color: #B59600; }
        .cell-status.uploaded { background: var(--kt-success-light); color: #1B8A5A; }
        .cell-status.uploading { background: rgba(114, 57, 234, 0.1); color: var(--kt-info); }
        .cell-status.transcribing { background: var(--kt-primary-light); color: var(--kt-primary); }

        .cell-indicator {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cell-indicator.success { background: var(--kt-success); }
        .cell-indicator.empty { background: transparent; }
        .cell-indicator svg { width: 18px; height: 18px; }

        .cell-flag {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cell-flag.danger { background: var(--kt-danger); }
        .cell-flag.empty { background: transparent; }
        .cell-flag svg { width: 14px; height: 14px; stroke: #fff; }

        /* Risk Rating Badge */
        .risk-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #fff;
        }
        .risk-badge.rating-a { background: var(--rating-a); }
        .risk-badge.rating-b { background: var(--rating-b); }
        .risk-badge.rating-c { background: var(--rating-c); }
        .risk-badge.rating-d { background: var(--rating-d); }

        /* Actions dropdown */
        .actions-wrapper {
            position: relative;
        }
        .actions-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--kt-gray-300);
            background: #fff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }
        .actions-btn:hover {
            background: var(--kt-gray-100);
            border-color: var(--kt-gray-400);
        }
        .actions-btn svg {
            width: 16px;
            height: 16px;
            stroke: var(--kt-gray-600);
        }
        .actions-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            min-width: 180px;
            background: #fff;
            border: 1px solid var(--kt-gray-300);
            border-radius: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .actions-dropdown.show { display: block; }
        .actions-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.8125rem;
            color: var(--kt-gray-700);
            transition: background 0.15s;
        }
        .actions-dropdown-item:hover { background: var(--kt-gray-100); }
        .actions-dropdown-item svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }
        .actions-dropdown-divider {
            height: 1px;
            background: var(--kt-gray-200);
            margin: 4px 0;
        }

        /* Skeleton Loading Animation */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--kt-gray-200) 25%, var(--kt-gray-100) 50%, var(--kt-gray-200) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        /* Loading spinner for sub-rows */
        .loading-row td {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--kt-gray-300);
            border-top-color: var(--kt-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Table Footer with Load More */
        .table-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid var(--kt-gray-200);
        }
        .table-info {
            font-size: 0.8125rem;
            color: var(--kt-gray-500);
        }
        .table-info strong {
            color: var(--kt-gray-700);
        }
        .load-more-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            background: var(--kt-primary);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        .load-more-btn:hover {
            background: #0f2200;
        }
        .load-more-btn:disabled {
            background: var(--kt-gray-300);
            cursor: not-allowed;
        }
        .load-more-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }
        .load-more-text {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .load-more-loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        .load-more-btn.loading .load-more-text {
            display: none;
        }
        .load-more-btn.loading .load-more-loading {
            display: inline-flex;
        }

        /* Chat button */
        .chat-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: #7ed321;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(126, 211, 33, 0.4);
            cursor: pointer;
            z-index: 100;
        }
        .chat-fab svg { width: 24px; height: 24px; stroke: #fff; }

        /* Property count badge */
        .property-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--kt-gray-200);
            border-radius: 10px;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--kt-gray-600);
            margin-left: 8px;
        }

        /* Cost display */
        .cost-value {
            font-weight: 600;
            color: var(--kt-gray-800);
        }

        /* Action buttons in sub-table */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .action-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }
        .action-btn-schedule {
            background: var(--kt-primary-light);
            color: var(--kt-primary);
        }
        .action-btn-schedule:hover {
            background: var(--kt-primary);
            color: #fff;
        }
        .action-btn-export {
            background: var(--kt-success-light);
            color: #1B8A5A;
        }
        .action-btn-export:hover {
            background: var(--kt-success);
            color: #fff;
        }
        .action-buttons {
            display: flex;
            gap: 6px;
        }

        /* Property action buttons */
        .prop-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid var(--kt-gray-300);
            background: #fff;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
            color: var(--kt-gray-700);
        }
        .prop-action-btn:hover {
            background: var(--kt-gray-100);
            border-color: var(--kt-gray-400);
        }
        .prop-action-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }
        .prop-action-btn.expand-action {
            background: var(--kt-primary-light);
            border-color: var(--kt-primary-light);
            color: var(--kt-primary);
        }
        .prop-action-btn.expand-action:hover {
            background: var(--kt-primary);
            border-color: var(--kt-primary);
            color: #fff;
        }
        .prop-action-btn.expand-action.expanded {
            background: var(--kt-primary);
            border-color: var(--kt-primary);
            color: #fff;
        }
        .prop-action-btn.export-action {
            background: var(--kt-success-light);
            border-color: var(--kt-success-light);
            color: #1B8A5A;
        }
        .prop-action-btn.export-action:hover {
            background: var(--kt-success);
            border-color: var(--kt-success);
            color: #fff;
        }
        .prop-actions {
            display: flex;
            gap: 6px;
        }

        /* Skeleton loading for inspection sub-table */
        .skeleton-sub-table {
            width: 100%;
            background: #fff;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .skeleton-sub-table .skeleton-header {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--kt-gray-200);
            border-bottom: 1px solid var(--kt-gray-300);
        }
        .skeleton-sub-table .skeleton-header-cell {
            height: 14px;
            background: linear-gradient(90deg, var(--kt-gray-300) 25%, var(--kt-gray-200) 50%, var(--kt-gray-300) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        .skeleton-sub-table .skeleton-row {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid var(--kt-gray-200);
        }
        .skeleton-sub-table .skeleton-row:last-child {
            border-bottom: none;
        }
        .skeleton-sub-table .skeleton-cell {
            height: 16px;
            background: linear-gradient(90deg, var(--kt-gray-200) 25%, var(--kt-gray-100) 50%, var(--kt-gray-200) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        .skeleton-cell.w-120 { width: 120px; }
        .skeleton-cell.w-80 { width: 80px; }
        .skeleton-cell.w-60 { width: 60px; }
        .skeleton-cell.w-100 { width: 100px; }
        .skeleton-cell.w-40 { width: 40px; }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Clickable inspection name */
        .inspection-link {
            color: var(--kt-primary);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        .inspection-link:hover {
            text-decoration: underline;
        }

        /* Items list display for repeating Section, Flagged, Risk Rating, Cost */
        .items-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .item-row {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            height: 24px;
            color: var(--kt-gray-700);
        }
        .item-row .risk-badge {
            width: 24px;
            height: 24px;
            font-size: 0.7rem;
        }
        .item-row .cell-flag {
            width: 20px;
            height: 20px;
        }
        .item-row .cell-flag svg {
            width: 12px;
            height: 12px;
        }

        /* Vertical align top for inspection rows */
        .sub-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--kt-gray-200);
            color: var(--kt-gray-700);
            vertical-align: top;
            white-space: nowrap;
        }
    </style>
</head>
<body class="sidebar-collapsed">

    <!-- LEFT SIDEBAR -->
    <aside class="sidebar collapsed">
        <div class="sidebar-logo">
            <img src="logo.png" alt="Surveyor Logo">
            <span>surveyor</span>
        </div>
        <nav class="nav-menu">
            <a href="properties-full.html" class="nav-item active" data-title="Home">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span class="nav-text">Home</span>
            </a>
            <a href="#" class="nav-item" data-title="Shared Reports">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                <span class="nav-text">Shared Reports</span>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </a>
            <a href="#" class="nav-item" data-title="Inspection Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                <span class="nav-text">Inspection Settings</span>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </a>
            <a href="#" class="nav-item" data-title="Report Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                <span class="nav-text">Report Settings</span>
            </a>
            <a href="#" class="nav-item" data-title="Bookings">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span class="nav-text">Bookings</span>
            </a>
            <a href="#" class="nav-item" data-title="Global Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                <span class="nav-text">Global Settings</span>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </a>
        </nav>
        <div class="sidebar-footer">
            <div class="switch-classic">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                <span>Switch to Imfuna Classic?</span>
            </div>
        </div>
    </aside>

    <!-- TOP HEADER -->
    <header class="top-header">
        <div class="header-left">
            <button class="collapse-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <a href="properties-full.html" class="header-nav-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Home
            </a>
        </div>
        <div class="header-right">
            <button class="header-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </button>
            <div class="avatar">K</div>
        </div>
    </header>

    <!-- SECONDARY NAV RIBBON -->
    <nav class="secondary-nav">
        <div class="secondary-nav-left">
            <a href="properties-full.html" class="secondary-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Properties
            </a>
            <a href="summary.html" class="secondary-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                Summary
            </a>
            <a href="statistics.html" class="secondary-nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                Statistics
            </a>
            <a href="risk-rating.html" class="secondary-nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                Risk Rating
            </a>
        </div>
    </nav>

    <!-- TOOLBAR RIBBON -->
    <div class="toolbar-ribbon">
        <!-- Search Box -->
        <div class="toolbar-search" data-tooltip="Search by address, postcode & city">
            <input type="text" placeholder="Search address, postcode & city..." id="searchInput">
            <button class="toolbar-search-btn" id="searchBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
        </div>

        <!-- Property Columns Multi-select -->
        <div class="multiselect-wrapper" data-tooltip="Show or hide property columns">
            <button class="multiselect-btn" id="propColumnsBtn">
                Property Columns <span class="multiselect-badge" id="propColumnsCount">0</span>
            </button>
            <div class="multiselect-dropdown" id="propColumnsDropdown">
                <div style="padding: 8px 14px; font-size: 0.7rem; color: var(--kt-gray-500); border-bottom: 1px solid var(--kt-gray-200);">Additional columns to display:</div>
                <label class="multiselect-option">
                    <input type="checkbox" value="partner"> Partner
                </label>
                <label class="multiselect-option">
                    <input type="checkbox" value="branch"> Branch
                </label>
            </div>
        </div>

        <!-- Inspection Columns Multi-select -->
        <div class="multiselect-wrapper" data-tooltip="Show or hide inspection columns">
            <button class="multiselect-btn" id="inspColumnsBtn">
                Inspection Columns <span class="multiselect-badge" id="inspColumnsCount">0</span>
            </button>
            <div class="multiselect-dropdown" id="inspColumnsDropdown">
                <div style="padding: 8px 14px; font-size: 0.7rem; color: var(--kt-gray-500); border-bottom: 1px solid var(--kt-gray-200);">Additional columns to display:</div>
                <label class="multiselect-option">
                    <input type="checkbox" value="sharedReview"> Shared Review
                </label>
                <label class="multiselect-option">
                    <input type="checkbox" value="commentsBack"> Comments Back
                </label>
                <label class="multiselect-option">
                    <input type="checkbox" value="sharedEsig"> Shared eSig
                </label>
                <label class="multiselect-option">
                    <input type="checkbox" value="pdfSigned"> PDF Signed
                </label>
            </div>
        </div>

        <!-- Risk Rating Multi-select -->
        <div class="multiselect-wrapper" data-tooltip="Filter by risk rating">
            <button class="multiselect-btn" id="riskRatingBtn">
                Risk Rating <span class="multiselect-badge" id="riskRatingCount">4</span>
            </button>
            <div class="multiselect-dropdown" id="riskRatingDropdown">
                <label class="multiselect-option">
                    <input type="checkbox" value="A" checked> <span class="risk-badge rating-a" style="width:18px;height:18px;font-size:0.65rem;">A</span> Rating A
                </label>
                <label class="multiselect-option">
                    <input type="checkbox" value="B" checked> <span class="risk-badge rating-b" style="width:18px;height:18px;font-size:0.65rem;">B</span> Rating B
                </label>
                <label class="multiselect-option">
                    <input type="checkbox" value="C" checked> <span class="risk-badge rating-c" style="width:18px;height:18px;font-size:0.65rem;">C</span> Rating C
                </label>
                <label class="multiselect-option">
                    <input type="checkbox" value="D" checked> <span class="risk-badge rating-d" style="width:18px;height:18px;font-size:0.65rem;">D</span> Rating D
                </label>
            </div>
        </div>

        <!-- Status Multi-select -->
        <div class="multiselect-wrapper" data-tooltip="Filter by inspection status">
            <button class="multiselect-btn" id="statusBtn">
                Status <span class="multiselect-badge" id="statusCount">4</span>
            </button>
            <div class="multiselect-dropdown" id="statusDropdown">
                <label class="multiselect-option">
                    <input type="checkbox" value="uploaded" checked> Uploaded
                </label>
                <label class="multiselect-option">
                    <input type="checkbox" value="pending" checked> Pending
                </label>
                <label class="multiselect-option">
                    <input type="checkbox" value="uploading" checked> Uploading
                </label>
                <label class="multiselect-option">
                    <input type="checkbox" value="transcribing" checked> Transcribing
                </label>
            </div>
        </div>

        <!-- Date Filter -->
        <div class="date-filter-wrapper" data-tooltip="Filter by date range">
            <button class="date-filter-btn" id="dateFilterBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;stroke:currentColor">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span id="dateFilterText">This Month</span>
            </button>
            <div class="date-filter-dropdown" id="dateFilterDropdown">
                <div class="date-option" data-value="week">This Week</div>
                <div class="date-option selected" data-value="month">This Month</div>
                <div class="date-option" data-value="3months">Last 3 Months</div>
                <div class="date-option" data-value="6months">Last 6 Months</div>
                <div class="date-option" data-value="1year">Last 1 Year</div>
                <div class="date-option-divider"></div>
                <div class="date-custom-range" id="customDateRange">
                    <div class="date-custom-label">Custom Range</div>
                    <div class="date-custom-inputs">
                        <div class="date-input-group">
                            <label>From</label>
                            <input type="date" id="dateFrom" class="date-input">
                        </div>
                        <div class="date-input-group">
                            <label>To</label>
                            <input type="date" id="dateTo" class="date-input">
                        </div>
                    </div>
                    <button class="date-apply-btn" id="applyCustomDate" onclick="applyCustomDateRange()">Apply</button>
                </div>
            </div>
        </div>

        <div class="toolbar-spacer"></div>

        <!-- Export Button -->
        <button class="btn-export" id="exportBtn" data-tooltip="Export data to CSV/Excel">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div class="card">
            <div class="card-body">
                <div class="table-wrapper">
                    <table class="data-table" id="riskRatingTable">
                        <thead id="tableHead">
                            <!-- Header will be rendered by JavaScript -->
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be rendered by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Table Footer with Load More -->
                <div class="table-footer" id="tableFooter">
                    <div class="table-info">
                        Showing <strong><span id="showingCount">0</span></strong> of <strong><span id="totalEntries">0</span></strong> properties
                    </div>
                    <button class="load-more-btn" id="loadMoreBtn" onclick="loadMore()">
                        <span class="load-more-text">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            Load More
                        </span>
                        <span class="load-more-loading" style="display: none;">
                            <span class="btn-spinner"></span>
                            Loading...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Chat Button -->
    <div class="chat-fab">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
        </svg>
    </div>

    <script>
        // Icons
        const tickIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
        const flagIcon = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>';
        const chevronIcon = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>';
        const moreIcon = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>';

        // Sample property data with inspections - each inspection has minimum 5 items with section, flagged, rating, cost
        // scheduleFreq is in months (numeric)
        const propertiesData = [
            {
                id: 1,
                address: '123 High Street, London',
                postcode: 'SW1A 1AA',
                refCode: 'REF-001',
                project: 'London Portfolio',
                partner: 'ABC Partners',
                branch: 'Central London',
                inspections: [
                    { id: 101, name: 'Annual Inspection', date: '2025-12-15', status: 'uploaded', pdfDone: true, inspector: 'John Smith', items: [{section: 'Wall', flagged: false, rating: 'A', cost: 500}, {section: 'Window', flagged: true, rating: 'B', cost: 1000}, {section: 'Kitchen', flagged: false, rating: 'A', cost: 500}, {section: 'Door', flagged: false, rating: 'C', cost: 1500}, {section: 'Bathroom', flagged: true, rating: 'B', cost: 1000}], nextInspection: '2026-12-15', scheduleFreq: 12, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: true },
                    { id: 102, name: 'Mid-Year Check', date: '2025-06-10', status: 'uploaded', pdfDone: true, inspector: 'Jane Doe', items: [{section: 'Wall', flagged: false, rating: 'A', cost: 500}, {section: 'Ceiling', flagged: false, rating: 'A', cost: 500}, {section: 'Floor', flagged: false, rating: 'B', cost: 1000}, {section: 'Window', flagged: false, rating: 'A', cost: 500}, {section: 'Door', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-06-10', scheduleFreq: 6, sharedReview: true, commentsBack: false, sharedEsig: false, pdfSigned: false }
                ]
            },
            {
                id: 2,
                address: '45 Park Lane, Manchester',
                postcode: 'M1 4BT',
                refCode: 'REF-002',
                project: 'Northern Assets',
                partner: 'XYZ Holdings',
                branch: 'Manchester',
                inspections: [
                    { id: 201, name: 'Quarterly Review', date: '2025-12-01', status: 'pending', pdfDone: false, inspector: 'Mike Wilson', items: [{section: 'Kitchen', flagged: true, rating: 'C', cost: 1500}, {section: 'Bathroom', flagged: true, rating: 'D', cost: 2000}, {section: 'Bedroom', flagged: true, rating: 'C', cost: 1500}, {section: 'Living Room', flagged: false, rating: 'B', cost: 1000}, {section: 'Hallway', flagged: true, rating: 'D', cost: 2000}], nextInspection: '2026-03-01', scheduleFreq: 3, sharedReview: false, commentsBack: false, sharedEsig: false, pdfSigned: false }
                ]
            },
            {
                id: 3,
                address: '78 Queen Street, Edinburgh',
                postcode: 'EH2 3NS',
                refCode: 'REF-003',
                project: 'Scottish Portfolio',
                partner: 'ABC Partners',
                branch: 'Edinburgh',
                inspections: [
                    { id: 301, name: 'Full Survey', date: '2025-06-20', status: 'uploaded', pdfDone: true, inspector: 'Sarah Brown', items: [{section: 'Wall', flagged: false, rating: 'B', cost: 1000}, {section: 'Window', flagged: false, rating: 'A', cost: 500}, {section: 'Roof', flagged: false, rating: 'B', cost: 1000}, {section: 'Foundation', flagged: false, rating: 'A', cost: 500}, {section: 'Garage', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-06-20', scheduleFreq: 12, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: false },
                    { id: 302, name: 'Fire Safety Check', date: '2025-03-15', status: 'uploaded', pdfDone: true, inspector: 'Tom Clark', items: [{section: 'Fire Alarm', flagged: false, rating: 'B', cost: 1000}, {section: 'Smoke Detector', flagged: false, rating: 'B', cost: 1000}, {section: 'Extinguisher', flagged: false, rating: 'A', cost: 500}, {section: 'Emergency Exit', flagged: false, rating: 'B', cost: 1000}, {section: 'Sprinkler', flagged: true, rating: 'C', cost: 1500}], nextInspection: '2026-03-15', scheduleFreq: 12, sharedReview: true, commentsBack: true, sharedEsig: false, pdfSigned: false },
                    { id: 303, name: 'Electrical Inspection', date: '2025-01-10', status: 'uploaded', pdfDone: true, inspector: 'Alan Davies', items: [{section: 'Fuse Box', flagged: true, rating: 'D', cost: 2000}, {section: 'Wiring', flagged: true, rating: 'C', cost: 1500}, {section: 'Outlets', flagged: true, rating: 'D', cost: 2000}, {section: 'Lighting', flagged: true, rating: 'C', cost: 1500}, {section: 'Switches', flagged: false, rating: 'B', cost: 1000}], nextInspection: '2026-01-10', scheduleFreq: 12, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: true }
                ]
            },
            {
                id: 4,
                address: '22 Castle Road, Bristol',
                postcode: 'BS1 3AD',
                refCode: 'REF-004',
                project: 'South West Fund',
                partner: 'DEF Capital',
                branch: 'Bristol',
                inspections: [
                    { id: 401, name: 'Initial Assessment', date: '2025-12-10', status: 'transcribing', pdfDone: false, inspector: 'Emily Jones', items: [{section: 'Wall', flagged: false, rating: 'B', cost: 1000}, {section: 'Ceiling', flagged: false, rating: 'A', cost: 500}, {section: 'Floor', flagged: false, rating: 'B', cost: 1000}, {section: 'Kitchen', flagged: false, rating: 'A', cost: 500}, {section: 'Bathroom', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-06-10', scheduleFreq: 6, sharedReview: false, commentsBack: false, sharedEsig: false, pdfSigned: false }
                ]
            },
            {
                id: 5,
                address: '15 Bridge Street, Birmingham',
                postcode: 'B1 2JB',
                refCode: 'REF-005',
                project: 'Midlands Trust',
                partner: 'GHI Investments',
                branch: 'Birmingham',
                inspections: [
                    { id: 501, name: 'Compliance Check', date: '2025-07-28', status: 'uploaded', pdfDone: true, inspector: 'David Lee', items: [{section: 'Fire Safety', flagged: true, rating: 'D', cost: 2000}, {section: 'Electrical', flagged: true, rating: 'C', cost: 1500}, {section: 'Plumbing', flagged: false, rating: 'B', cost: 1000}, {section: 'HVAC', flagged: true, rating: 'C', cost: 1500}, {section: 'Structure', flagged: true, rating: 'D', cost: 2000}], nextInspection: '2026-07-28', scheduleFreq: 3, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: true },
                    { id: 502, name: 'Safety Audit', date: '2025-04-15', status: 'uploaded', pdfDone: true, inspector: 'Lisa Wang', items: [{section: 'Handrails', flagged: true, rating: 'C', cost: 1500}, {section: 'Stairs', flagged: false, rating: 'B', cost: 1000}, {section: 'Lighting', flagged: true, rating: 'C', cost: 1500}, {section: 'Floor Surface', flagged: false, rating: 'B', cost: 1000}, {section: 'Signage', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-04-15', scheduleFreq: 12, sharedReview: true, commentsBack: false, sharedEsig: false, pdfSigned: false }
                ]
            },
            {
                id: 6,
                address: '89 Victoria Road, Leeds',
                postcode: 'LS1 5QN',
                refCode: 'REF-006',
                project: 'Yorkshire Portfolio',
                partner: 'JKL Properties',
                branch: 'Leeds',
                inspections: [
                    { id: 601, name: 'Annual Survey', date: '2025-12-05', status: 'uploading', pdfDone: false, inspector: 'Chris Taylor', items: [{section: 'Exterior', flagged: false, rating: 'A', cost: 500}, {section: 'Interior', flagged: false, rating: 'A', cost: 500}, {section: 'Roof', flagged: false, rating: 'B', cost: 1000}, {section: 'Foundation', flagged: false, rating: 'A', cost: 500}, {section: 'Landscaping', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-12-05', scheduleFreq: 12, sharedReview: false, commentsBack: false, sharedEsig: false, pdfSigned: false }
                ]
            },
            {
                id: 7,
                address: '33 Market Square, Cardiff',
                postcode: 'CF10 1EP',
                refCode: 'REF-007',
                project: 'Welsh Assets',
                partner: 'MNO Holdings',
                branch: 'Cardiff',
                inspections: [
                    { id: 701, name: 'Structural Review', date: '2025-11-30', status: 'uploaded', pdfDone: true, inspector: 'Rachel Green', items: [{section: 'Load Bearing Wall', flagged: false, rating: 'A', cost: 500}, {section: 'Beams', flagged: false, rating: 'A', cost: 500}, {section: 'Columns', flagged: false, rating: 'B', cost: 1000}, {section: 'Foundation', flagged: false, rating: 'A', cost: 500}, {section: 'Roof Truss', flagged: false, rating: 'B', cost: 1000}], nextInspection: '2026-11-30', scheduleFreq: 12, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: true }
                ]
            },
            {
                id: 8,
                address: '56 Harbour View, Liverpool',
                postcode: 'L3 9PP',
                refCode: 'REF-008',
                project: 'Merseyside Fund',
                partner: 'PQR Capital',
                branch: 'Liverpool',
                inspections: [
                    { id: 801, name: 'Quarterly Check', date: '2025-12-08', status: 'pending', pdfDone: false, inspector: 'James Wilson', items: [{section: 'Wall', flagged: false, rating: 'B', cost: 1000}, {section: 'Window', flagged: false, rating: 'A', cost: 500}, {section: 'Door', flagged: false, rating: 'B', cost: 1000}, {section: 'Ceiling', flagged: true, rating: 'C', cost: 1500}, {section: 'Floor', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-03-08', scheduleFreq: 3, sharedReview: false, commentsBack: false, sharedEsig: false, pdfSigned: false },
                    { id: 802, name: 'Previous Quarter', date: '2025-09-08', status: 'uploaded', pdfDone: true, inspector: 'James Wilson', items: [{section: 'Kitchen', flagged: false, rating: 'B', cost: 1000}, {section: 'Bathroom', flagged: false, rating: 'B', cost: 1000}, {section: 'Bedroom', flagged: false, rating: 'A', cost: 500}, {section: 'Living Room', flagged: false, rating: 'A', cost: 500}, {section: 'Dining Room', flagged: false, rating: 'B', cost: 1000}], nextInspection: '2025-12-08', scheduleFreq: 3, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: true }
                ]
            },
            {
                id: 9,
                address: '101 Ocean Drive, Brighton',
                postcode: 'BN1 2LR',
                refCode: 'REF-009',
                project: 'Coastal Portfolio',
                partner: 'STU Investments',
                branch: 'Brighton',
                inspections: [
                    { id: 901, name: 'Bi-Annual Survey', date: '2025-11-25', status: 'uploaded', pdfDone: true, inspector: 'Anna Smith', items: [{section: 'Exterior Paint', flagged: true, rating: 'C', cost: 1500}, {section: 'Window Seals', flagged: false, rating: 'B', cost: 1000}, {section: 'Gutters', flagged: true, rating: 'C', cost: 1500}, {section: 'Drainage', flagged: true, rating: 'D', cost: 2000}, {section: 'Damp Check', flagged: true, rating: 'C', cost: 1500}], nextInspection: '2026-05-25', scheduleFreq: 6, sharedReview: true, commentsBack: true, sharedEsig: false, pdfSigned: false }
                ]
            },
            {
                id: 10,
                address: '72 Forest Lane, Nottingham',
                postcode: 'NG1 7JK',
                refCode: 'REF-010',
                project: 'East Midlands Trust',
                partner: 'VWX Partners',
                branch: 'Nottingham',
                inspections: [
                    { id: 1001, name: 'Full Inspection', date: '2025-12-12', status: 'uploaded', pdfDone: true, inspector: 'Peter Brown', items: [{section: 'Kitchen', flagged: false, rating: 'A', cost: 500}, {section: 'Bathroom', flagged: false, rating: 'A', cost: 500}, {section: 'Bedroom', flagged: false, rating: 'A', cost: 500}, {section: 'Living Room', flagged: false, rating: 'B', cost: 1000}, {section: 'Garden', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-12-12', scheduleFreq: 12, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: true },
                    { id: 1002, name: 'Gas Safety', date: '2025-10-01', status: 'uploaded', pdfDone: true, inspector: 'Mark Johnson', items: [{section: 'Boiler', flagged: false, rating: 'A', cost: 500}, {section: 'Pipework', flagged: false, rating: 'B', cost: 1000}, {section: 'Radiators', flagged: false, rating: 'A', cost: 500}, {section: 'Flue', flagged: false, rating: 'A', cost: 500}, {section: 'Ventilation', flagged: false, rating: 'A', cost: 500}], nextInspection: '2026-10-01', scheduleFreq: 12, sharedReview: true, commentsBack: true, sharedEsig: true, pdfSigned: true }
                ]
            }
        ];

        // Track expanded rows and loading states
        const expandedRows = new Set();
        const loadingRows = new Set();

        // Batch loading settings
        const BATCH_SIZE = 10;
        let loadedCount = 10;

        // Sidebar toggle
        const sidebar = document.querySelector('.sidebar');
        const collapseBtn = document.querySelector('.collapse-btn');

        collapseBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            document.body.classList.toggle('sidebar-collapsed');
        });

        // Calculate total cost for an inspection (sum of all item costs)
        function getInspectionTotalCost(inspection) {
            return inspection.items.reduce((sum, item) => sum + item.cost, 0);
        }

        // Calculate total cost for a property (sum of all inspections)
        function getPropertyTotalCost(property) {
            return property.inspections.reduce((sum, insp) => sum + getInspectionTotalCost(insp), 0);
        }

        // Generate skeleton HTML
        function getSkeletonHtml() {
            return `
                <div class="skeleton-sub-table">
                    <div class="skeleton-header">
                        <div class="skeleton-header-cell w-120"></div>
                        <div class="skeleton-header-cell w-80"></div>
                        <div class="skeleton-header-cell w-60"></div>
                        <div class="skeleton-header-cell w-60"></div>
                        <div class="skeleton-header-cell w-80"></div>
                        <div class="skeleton-header-cell w-40"></div>
                        <div class="skeleton-header-cell w-60"></div>
                        <div class="skeleton-header-cell w-60"></div>
                        <div class="skeleton-header-cell w-80"></div>
                        <div class="skeleton-header-cell w-80"></div>
                        <div class="skeleton-header-cell w-100"></div>
                    </div>
                    <div class="skeleton-row">
                        <div class="skeleton-cell w-120"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-40"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-100"></div>
                    </div>
                    <div class="skeleton-row">
                        <div class="skeleton-cell w-120"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-40"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-100"></div>
                    </div>
                    <div class="skeleton-row">
                        <div class="skeleton-cell w-120"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-40"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-60"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-80"></div>
                        <div class="skeleton-cell w-100"></div>
                    </div>
                </div>
            `;
        }

        // Search term
        let searchTerm = '';

        // Current date filter settings
        let currentDateFilter = 'month'; // week, month, 3months, 6months, 1year, custom
        let customDateFrom = null;
        let customDateTo = null;

        // Get date range based on filter
        function getDateRange(filter) {
            const today = new Date();
            let fromDate = new Date();

            switch(filter) {
                case 'week':
                    fromDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    fromDate.setMonth(today.getMonth() - 1);
                    break;
                case '3months':
                    fromDate.setMonth(today.getMonth() - 3);
                    break;
                case '6months':
                    fromDate.setMonth(today.getMonth() - 6);
                    break;
                case '1year':
                    fromDate.setFullYear(today.getFullYear() - 1);
                    break;
                case 'custom':
                    return { from: customDateFrom, to: customDateTo };
                default:
                    fromDate.setMonth(today.getMonth() - 1);
            }

            return { from: fromDate, to: today };
        }

        // Get filtered properties based on search and date filter
        function getFilteredProperties() {
            let filtered = [...propertiesData];

            // Search filter (property fields only)
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(property =>
                    property.address.toLowerCase().includes(term) ||
                    property.postcode.toLowerCase().includes(term) ||
                    property.refCode.toLowerCase().includes(term) ||
                    property.project.toLowerCase().includes(term) ||
                    property.partner.toLowerCase().includes(term) ||
                    property.branch.toLowerCase().includes(term)
                );
            }

            // Date filter - filter by inspection dates
            const dateRange = getDateRange(currentDateFilter);
            if (dateRange.from && dateRange.to) {
                filtered = filtered.filter(property => {
                    // Check if any inspection falls within the date range
                    return property.inspections.some(inspection => {
                        const inspDate = new Date(inspection.date);
                        return inspDate >= dateRange.from && inspDate <= dateRange.to;
                    });
                });
            }

            return filtered;
        }

        // Render table header
        function renderTableHeader() {
            const thead = document.getElementById('tableHead');
            const showPartner = document.querySelector('#propColumnsDropdown input[value="partner"]')?.checked || false;
            const showBranch = document.querySelector('#propColumnsDropdown input[value="branch"]')?.checked || false;

            let headerHtml = `
                <tr>
                    <th class="sortable" data-column="address">Address <span class="sort-icon"></span></th>
                    <th class="sortable" data-column="postcode">Postcode <span class="sort-icon"></span></th>
                    <th class="sortable" data-column="refCode">Ref Code <span class="sort-icon"></span></th>
                    <th class="sortable" data-column="project">Project <span class="sort-icon"></span></th>
                    ${showPartner ? '<th class="sortable" data-column="partner">Partner <span class="sort-icon"></span></th>' : ''}
                    ${showBranch ? '<th class="sortable" data-column="branch">Branch <span class="sort-icon"></span></th>' : ''}
                    <th style="width: 100px;">Action</th>
                </tr>
            `;
            thead.innerHTML = headerHtml;
        }

        // Render property rows
        function renderTable() {
            renderTableHeader();

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            // Get property column visibility
            const showPartner = document.querySelector('#propColumnsDropdown input[value="partner"]')?.checked || false;
            const showBranch = document.querySelector('#propColumnsDropdown input[value="branch"]')?.checked || false;

            // Get filtered data
            const filteredData = getFilteredProperties();

            // Get data limited by loadedCount
            const displayData = filteredData.slice(0, loadedCount);

            // Update footer counts
            document.getElementById('showingCount').textContent = displayData.length;
            document.getElementById('totalEntries').textContent = filteredData.length;

            // Show/hide load more button
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            if (displayData.length >= filteredData.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'inline-flex';
            }

            // Calculate colspan based on visible columns
            const propColCount = 4 + (showPartner ? 1 : 0) + (showBranch ? 1 : 0) + 1; // default 4 + optional + action

            displayData.forEach(property => {
                // Property row
                const isExpanded = expandedRows.has(property.id);
                const isLoading = loadingRows.has(property.id);
                const propertyRow = document.createElement('tr');
                propertyRow.className = `property-row ${isExpanded ? 'expanded' : ''}`;
                propertyRow.dataset.propertyId = property.id;

                propertyRow.innerHTML = `
                    <td>
                        <a href="#" class="cell-link">${property.address}</a>
                        <span class="property-count">${property.inspections.length}</span>
                    </td>
                    <td>${property.postcode}</td>
                    <td>${property.refCode}</td>
                    <td>${property.project}</td>
                    ${showPartner ? `<td>${property.partner}</td>` : ''}
                    ${showBranch ? `<td>${property.branch}</td>` : ''}
                    <td>
                        <button class="prop-action-btn expand-action ${isExpanded ? 'expanded' : ''}" data-property-id="${property.id}" onclick="toggleExpand(${property.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="transform: ${isExpanded ? 'rotate(180deg)' : 'rotate(0deg)'}; transition: transform 0.2s;">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            ${isExpanded ? 'Collapse' : 'Expand'}
                        </button>
                    </td>
                `;

                tbody.appendChild(propertyRow);

                // Inspection sub-table container
                if (isExpanded || isLoading) {
                    const containerRow = document.createElement('tr');
                    containerRow.className = 'inspection-container';

                    // Show skeleton loading if loading
                    if (isLoading) {
                        containerRow.innerHTML = `<td colspan="${propColCount}">${getSkeletonHtml()}</td>`;
                        tbody.appendChild(containerRow);
                    } else {
                        // Get selected additional columns from global state
                        const inspCols = getInspColumnStates();
                        const showSharedReview = inspCols.sharedReview;
                        const showCommentsBack = inspCols.commentsBack;
                        const showSharedEsig = inspCols.sharedEsig;
                        const showPdfSigned = inspCols.pdfSigned;

                        // Get selected filters from toolbar
                        const selectedRatings = getSelectedRatings();
                        const selectedStatuses = getSelectedStatuses();

                        // Filter inspections based on property-level filters
                        const filteredInspections = property.inspections.filter(inspection => {
                            // Status filter
                            if (!selectedStatuses.includes(inspection.status)) return false;
                            // Rating filter - include if any item matches
                            if (!inspection.items.some(item => selectedRatings.includes(item.rating))) return false;
                            return true;
                        });

                        // Build inspection rows HTML
                        let inspectionRowsHtml = '';
                        filteredInspections.forEach((inspection, index) => {
                            // Filter items by selected ratings
                            const filteredItems = inspection.items.filter(item => selectedRatings.includes(item.rating));
                            const inspCost = filteredItems.reduce((sum, item) => sum + item.cost, 0);

                            // Build repeating items display (Section, Flagged, Risk Rating, Cost)
                            const sectionsHtml = filteredItems.map(item => `
                                <div class="item-row">${item.section}</div>
                            `).join('');

                            const flaggedHtml = filteredItems.map(item => `
                                <div class="item-row">${item.flagged ? '<div class="cell-flag danger" style="width:20px;height:20px;">' + flagIcon + '</div>' : '<div class="cell-flag empty" style="width:20px;height:20px;"></div>'}</div>
                            `).join('');

                            const ratingsHtml = filteredItems.map(item => `
                                <div class="item-row">
                                    <span class="risk-badge rating-${item.rating.toLowerCase()}">${item.rating}</span>
                                </div>
                            `).join('');

                            const costsHtml = filteredItems.map(item => `
                                <div class="item-row">£${item.cost.toFixed(2)}</div>
                            `).join('');

                            inspectionRowsHtml += `
                                <tr>
                                    <td><a href="#" class="inspection-link" onclick="viewInspection(${inspection.id})">${inspection.name}</a></td>
                                    <td>${inspection.date}</td>
                                    <td><span class="cell-status ${inspection.status}">${capitalizeFirst(inspection.status)}</span></td>
                                    <td>${inspection.pdfDone ? '<div class="cell-indicator success">' + tickIcon + '</div>' : '<div class="cell-indicator empty"></div>'}</td>
                                    <td>${inspection.inspector}</td>
                                    <td><div class="items-list">${sectionsHtml}</div></td>
                                    <td><div class="items-list">${flaggedHtml}</div></td>
                                    <td><div class="items-list">${ratingsHtml}</div></td>
                                    <td><div class="items-list">${costsHtml}</div></td>
                                    <td class="cost-value">£${inspCost.toFixed(2)}</td>
                                    <td>${inspection.nextInspection}</td>
                                    <td>${inspection.scheduleFreq}</td>
                                    ${showSharedReview ? `<td>${inspection.sharedReview ? '<div class="cell-indicator success" style="width:24px;height:24px;display:inline-flex;">' + tickIcon + '</div>' : '<div class="cell-indicator empty" style="width:24px;height:24px;"></div>'}</td>` : ''}
                                    ${showCommentsBack ? `<td>${inspection.commentsBack ? '<div class="cell-indicator success" style="width:24px;height:24px;display:inline-flex;">' + tickIcon + '</div>' : '<div class="cell-indicator empty" style="width:24px;height:24px;"></div>'}</td>` : ''}
                                    ${showSharedEsig ? `<td>${inspection.sharedEsig ? '<div class="cell-indicator success" style="width:24px;height:24px;display:inline-flex;">' + tickIcon + '</div>' : '<div class="cell-indicator empty" style="width:24px;height:24px;"></div>'}</td>` : ''}
                                    ${showPdfSigned ? `<td>${inspection.pdfSigned ? '<div class="cell-indicator success" style="width:24px;height:24px;display:inline-flex;">' + tickIcon + '</div>' : '<div class="cell-indicator empty" style="width:24px;height:24px;"></div>'}</td>` : ''}
                                    <td>
                                        <div class="action-buttons">
                                            <button class="action-btn action-btn-schedule" onclick="scheduleInspection(${property.id}, ${index})">
                                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                                </svg>
                                                Schedule
                                            </button>
                                            <button class="action-btn action-btn-export" onclick="exportInspection(${property.id}, ${inspection.id})">
                                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                    <polyline points="7 10 12 15 17 10"></polyline>
                                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                                </svg>
                                                Export
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });

                        // Count additional columns for colspan
                        const additionalColCount = (showSharedReview ? 1 : 0) + (showCommentsBack ? 1 : 0) + (showSharedEsig ? 1 : 0) + (showPdfSigned ? 1 : 0);

                        // Calculate total cost for all inspections
                        const totalCost = getPropertyTotalCost(property);

                        containerRow.innerHTML = `
                            <td colspan="${propColCount}">
                                <div class="sub-table-wrapper">
                                    <table class="sub-table">
                                        <thead>
                                            <tr>
                                                <th>Inspection Name</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>PDF Done</th>
                                                <th>Inspector</th>
                                                <th>Section</th>
                                                <th>Flagged</th>
                                                <th>Risk Rating</th>
                                                <th>Cost</th>
                                                <th>Total Cost</th>
                                                <th>Next Inspection</th>
                                                <th>Schedule Freq</th>
                                                ${showSharedReview ? '<th>Shared Review</th>' : ''}
                                                ${showCommentsBack ? '<th>Comments Back</th>' : ''}
                                                ${showSharedEsig ? '<th>Shared eSig</th>' : ''}
                                                ${showPdfSigned ? '<th>PDF Signed</th>' : ''}
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inspectionBody_${property.id}">
                                            ${inspectionRowsHtml}
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        `;

                        tbody.appendChild(containerRow);
                    }
                }
            });
        }

        // Toggle expand with skeleton loading simulation
        function toggleExpand(propertyId) {
            if (expandedRows.has(propertyId)) {
                // Collapse
                expandedRows.delete(propertyId);
                loadingRows.delete(propertyId);
                renderTable();
            } else {
                // Expand with loading
                loadingRows.add(propertyId);
                renderTable();

                // Simulate loading delay
                setTimeout(() => {
                    loadingRows.delete(propertyId);
                    expandedRows.add(propertyId);
                    renderTable();
                }, 800);
            }
        }

        // View inspection
        function viewInspection(inspectionId) {
            console.log('Viewing inspection:', inspectionId);
            alert(`Opening inspection view for ID: ${inspectionId}`);
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Apply custom date range
        function applyCustomDateRange() {
            const fromDateVal = document.getElementById('dateFrom').value;
            const toDateVal = document.getElementById('dateTo').value;

            if (fromDateVal && toDateVal) {
                // Set custom date filter variables
                customDateFrom = new Date(fromDateVal);
                customDateTo = new Date(toDateVal);
                currentDateFilter = 'custom';

                // Format the dates for display
                const options = { day: 'numeric', month: 'short' };
                const fromStr = customDateFrom.toLocaleDateString('en-GB', options);
                const toStr = customDateTo.toLocaleDateString('en-GB', options);

                // Update the button text
                document.getElementById('dateFilterText').textContent = `${fromStr} - ${toStr}`;

                // Remove selected class from all options
                document.querySelectorAll('.date-option').forEach(opt => opt.classList.remove('selected'));

                // Close dropdown
                document.getElementById('dateFilterDropdown').classList.remove('show');
                document.getElementById('dateFilterBtn').classList.remove('active');

                // Reset loaded count and re-render
                loadedCount = BATCH_SIZE;
                renderTable();
            } else {
                alert('Please select both From and To dates');
            }
        }

        function attachEventListeners() {
            // No additional event listeners needed - using onclick directly
        }

        function exportProperty(propertyId) {
            const property = propertiesData.find(p => p.id === propertyId);
            if (property) {
                console.log('Exporting property:', propertyId);
                alert(`Exporting property: ${property.address}\nInspections: ${property.inspections.length}\nTotal Cost: £${getPropertyTotalCost(property).toFixed(2)}`);
            }
        }

        // Load more properties
        function loadMore() {
            const btn = document.getElementById('loadMoreBtn');
            btn.classList.add('loading');
            btn.disabled = true;

            // Simulate loading delay
            setTimeout(() => {
                loadedCount += BATCH_SIZE;
                renderTable();
                btn.classList.remove('loading');
                btn.disabled = false;
            }, 800);
        }

        // Get inspection column states from toolbar dropdown
        function getInspColumnStates() {
            const dropdown = document.getElementById('inspColumnsDropdown');
            return {
                sharedReview: dropdown?.querySelector('input[value="sharedReview"]')?.checked || false,
                commentsBack: dropdown?.querySelector('input[value="commentsBack"]')?.checked || false,
                sharedEsig: dropdown?.querySelector('input[value="sharedEsig"]')?.checked || false,
                pdfSigned: dropdown?.querySelector('input[value="pdfSigned"]')?.checked || false
            };
        }

        // Get selected risk ratings from toolbar
        function getSelectedRatings() {
            const dropdown = document.getElementById('riskRatingDropdown');
            if (!dropdown) return ['A', 'B', 'C', 'D'];
            return Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }

        // Get selected statuses from toolbar
        function getSelectedStatuses() {
            const dropdown = document.getElementById('statusDropdown');
            if (!dropdown) return ['uploaded', 'pending', 'uploading', 'transcribing'];
            return Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }

        // Inspection action functions
        function scheduleInspection(propertyId, inspectionIndex) {
            const property = propertiesData.find(p => p.id === propertyId);
            if (property && property.inspections[inspectionIndex]) {
                const inspection = property.inspections[inspectionIndex];
                console.log('Scheduling inspection:', inspection.name, 'for property:', property.address);
                alert(`Schedule inspection: ${inspection.name}\nProperty: ${property.address}\nNext: ${inspection.nextInspection}`);
            }
        }

        function exportInspection(propertyId, inspectionId) {
            const property = propertiesData.find(p => p.id === propertyId);
            if (property) {
                const inspection = property.inspections.find(i => i.id === inspectionId);
                if (inspection) {
                    const totalCost = getInspectionTotalCost(inspection);
                    console.log('Exporting inspection:', inspection.name, 'at', property.address);
                    alert(`Exporting: ${inspection.name}\nProperty: ${property.address}\nTotal Cost: £${totalCost.toFixed(2)}`);
                }
            }
        }

        // Filter inspections within a property row
        function filterInspections(propertyId) {
            const property = propertiesData.find(p => p.id === propertyId);
            if (!property) return;

            // Get selected ratings from multi-select
            const ratingDropdown = document.getElementById(`inspRatingDropdown_${propertyId}`);
            const selectedRatings = ratingDropdown
                ? Array.from(ratingDropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value)
                : ['A', 'B', 'C', 'D'];

            // Get selected statuses from multi-select
            const statusDropdown = document.getElementById(`inspStatusDropdown_${propertyId}`);
            const selectedStatuses = statusDropdown
                ? Array.from(statusDropdown.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value)
                : ['uploaded', 'pending', 'uploading', 'transcribing'];

            const pdfOnlyFilter = document.getElementById(`inspPdfFilter_${propertyId}`)?.checked || false;

            // Get inspection column visibility from global state
            const showSharedReview = inspColumnStates.sharedReview;
            const showCommentsBack = inspColumnStates.commentsBack;
            const showSharedEsig = inspColumnStates.sharedEsig;
            const showPdfSigned = inspColumnStates.pdfSigned;
            const additionalColCount = (showSharedReview ? 1 : 0) + (showCommentsBack ? 1 : 0) + (showSharedEsig ? 1 : 0) + (showPdfSigned ? 1 : 0);

            // Filter inspections by multi-select status and pdf done
            let filteredInspections = property.inspections.filter(inspection => {
                // Rating filter - check if any item has a selected rating
                if (selectedRatings.length < 4 && !inspection.items.some(item => selectedRatings.includes(item.rating))) {
                    return false;
                }
                // Status filter - multi-select
                if (selectedStatuses.length < 4 && !selectedStatuses.includes(inspection.status)) {
                    return false;
                }
                // PDF Done filter
                if (pdfOnlyFilter && !inspection.pdfDone) {
                    return false;
                }
                return true;
            });

            // Calculate filtered total cost (based on filtered items if rating filter is set)
            let filteredTotalCost = 0;
            filteredInspections.forEach(insp => {
                if (selectedRatings.length < 4) {
                    // Sum only items matching the selected ratings
                    filteredTotalCost += insp.items
                        .filter(item => selectedRatings.includes(item.rating))
                        .reduce((sum, item) => sum + item.cost, 0);
                } else {
                    // Sum all items
                    filteredTotalCost += getInspectionTotalCost(insp);
                }
            });

            // Update the total cost in ribbon
            const totalCostEl = document.getElementById(`inspTotalCost_${propertyId}`);
            if (totalCostEl) {
                totalCostEl.textContent = `£${filteredTotalCost.toFixed(2)}`;
            }

            // Build filtered rows HTML
            let filteredRowsHtml = '';
            filteredInspections.forEach((inspection, index) => {
                // Filter items based on selected ratings
                const filteredItems = selectedRatings.length < 4
                    ? inspection.items.filter(item => selectedRatings.includes(item.rating))
                    : inspection.items;

                // Calculate inspection cost based on filtered items
                const inspCost = filteredItems.reduce((sum, item) => sum + item.cost, 0);

                const sectionsHtml = filteredItems.map(item => `
                    <div class="item-row">${item.section}</div>
                `).join('');

                const flaggedHtml = filteredItems.map(item => `
                    <div class="item-row">${item.flagged ? '<div class="cell-flag danger" style="width:20px;height:20px;">' + flagIcon + '</div>' : '<div class="cell-flag empty" style="width:20px;height:20px;"></div>'}</div>
                `).join('');

                const ratingsHtml = filteredItems.map(item => `
                    <div class="item-row">
                        <span class="risk-badge rating-${item.rating.toLowerCase()}">${item.rating}</span>
                    </div>
                `).join('');

                const costsHtml = filteredItems.map(item => `
                    <div class="item-row">£${item.cost.toFixed(2)}</div>
                `).join('');

                filteredRowsHtml += `
                    <tr>
                        <td><a href="#" class="inspection-link" onclick="viewInspection(${inspection.id})">${inspection.name}</a></td>
                        <td>${inspection.date}</td>
                        <td><span class="cell-status ${inspection.status}">${capitalizeFirst(inspection.status)}</span></td>
                        <td>${inspection.pdfDone ? '<div class="cell-indicator success">' + tickIcon + '</div>' : '<div class="cell-indicator empty"></div>'}</td>
                        <td>${inspection.inspector}</td>
                        <td><div class="items-list">${sectionsHtml}</div></td>
                        <td><div class="items-list">${flaggedHtml}</div></td>
                        <td><div class="items-list">${ratingsHtml}</div></td>
                        <td><div class="items-list">${costsHtml}</div></td>
                        <td class="cost-value">£${inspCost.toFixed(2)}</td>
                        <td>${inspection.nextInspection}</td>
                        <td>${inspection.scheduleFreq}</td>
                        ${showSharedReview ? `<td>${inspection.sharedReview ? '<div class="cell-indicator success" style="width:24px;height:24px;display:inline-flex;">' + tickIcon + '</div>' : '<div class="cell-indicator empty" style="width:24px;height:24px;"></div>'}</td>` : ''}
                        ${showCommentsBack ? `<td>${inspection.commentsBack ? '<div class="cell-indicator success" style="width:24px;height:24px;display:inline-flex;">' + tickIcon + '</div>' : '<div class="cell-indicator empty" style="width:24px;height:24px;"></div>'}</td>` : ''}
                        ${showSharedEsig ? `<td>${inspection.sharedEsig ? '<div class="cell-indicator success" style="width:24px;height:24px;display:inline-flex;">' + tickIcon + '</div>' : '<div class="cell-indicator empty" style="width:24px;height:24px;"></div>'}</td>` : ''}
                        ${showPdfSigned ? `<td>${inspection.pdfSigned ? '<div class="cell-indicator success" style="width:24px;height:24px;display:inline-flex;">' + tickIcon + '</div>' : '<div class="cell-indicator empty" style="width:24px;height:24px;"></div>'}</td>` : ''}
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn action-btn-schedule" onclick="scheduleInspection(${property.id}, ${index})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                    Schedule
                                </button>
                                <button class="action-btn action-btn-export" onclick="exportInspection(${property.id}, ${inspection.id})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    Export
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            // Update the inspection tbody
            const inspBody = document.getElementById(`inspectionBody_${propertyId}`);
            if (inspBody) {
                inspBody.innerHTML = filteredRowsHtml;
            }
        }

        // Dropdown handlers
        function setupDropdown(btnId, dropdownId) {
            const btn = document.getElementById(btnId);
            const dropdown = document.getElementById(dropdownId);

            if (!btn || !dropdown) return;

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                btn.classList.toggle('active');
                dropdown.classList.toggle('show');

                // Close other dropdowns
                document.querySelectorAll('.multiselect-dropdown, .date-filter-dropdown, .actions-dropdown').forEach(d => {
                    if (d !== dropdown) d.classList.remove('show');
                });
                document.querySelectorAll('.multiselect-btn, .date-filter-btn').forEach(b => {
                    if (b !== btn) b.classList.remove('active');
                });
            });
        }

        setupDropdown('propColumnsBtn', 'propColumnsDropdown');
        setupDropdown('inspColumnsBtn', 'inspColumnsDropdown');
        setupDropdown('riskRatingBtn', 'riskRatingDropdown');
        setupDropdown('statusBtn', 'statusDropdown');
        setupDropdown('dateFilterBtn', 'dateFilterDropdown');

        // Property Columns filter
        const propColumnsCheckboxes = document.querySelectorAll('#propColumnsDropdown input[type="checkbox"]');
        const propColumnsCount = document.getElementById('propColumnsCount');

        propColumnsCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checked = document.querySelectorAll('#propColumnsDropdown input[type="checkbox"]:checked').length;
                propColumnsCount.textContent = checked;
                // Re-render table to show/hide property columns
                renderTable();
            });
        });

        // Inspection Columns filter
        const inspColumnsCheckboxes = document.querySelectorAll('#inspColumnsDropdown input[type="checkbox"]');
        const inspColumnsCount = document.getElementById('inspColumnsCount');

        inspColumnsCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checked = document.querySelectorAll('#inspColumnsDropdown input[type="checkbox"]:checked').length;
                inspColumnsCount.textContent = checked;
                renderTable();
            });
        });

        // Risk Rating filter
        const riskRatingCheckboxes = document.querySelectorAll('#riskRatingDropdown input[type="checkbox"]');
        const riskRatingCount = document.getElementById('riskRatingCount');

        riskRatingCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checked = document.querySelectorAll('#riskRatingDropdown input[type="checkbox"]:checked').length;
                riskRatingCount.textContent = checked;
                renderTable();
            });
        });

        // Status filter
        const statusCheckboxes = document.querySelectorAll('#statusDropdown input[type="checkbox"]');
        const statusCount = document.getElementById('statusCount');

        statusCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checked = document.querySelectorAll('#statusDropdown input[type="checkbox"]:checked').length;
                statusCount.textContent = checked;
                renderTable();
            });
        });

        // Date filter
        const dateOptions = document.querySelectorAll('.date-option');
        const dateFilterText = document.getElementById('dateFilterText');

        dateOptions.forEach(option => {
            option.addEventListener('click', () => {
                const value = option.getAttribute('data-value');

                dateOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                dateFilterText.textContent = option.textContent.trim();
                document.getElementById('dateFilterDropdown').classList.remove('show');
                document.getElementById('dateFilterBtn').classList.remove('active');

                // Update current date filter
                currentDateFilter = value;

                // Reset loaded count and re-render when date filter changes
                loadedCount = BATCH_SIZE;
                renderTable();
            });
        });

        // Close all dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.multiselect-dropdown, .date-filter-dropdown, .actions-dropdown, .insp-columns-dropdown, .insp-multiselect-dropdown').forEach(d => d.classList.remove('show'));
            document.querySelectorAll('.multiselect-btn, .date-filter-btn, .insp-columns-btn, .insp-multiselect-btn').forEach(b => b.classList.remove('active'));
        });

        // Search functionality (property fields only)
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderTable();
        });

        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchTerm = e.target.value;
                renderTable();
            }
        });

        searchBtn.addEventListener('click', () => {
            searchTerm = searchInput.value;
            renderTable();
        });

        // Initialize table
        renderTable();
    </script>
</body>
</html>
